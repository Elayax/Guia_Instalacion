<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>Gestión de BD</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
</head>

<body>

    <!-- HEADER UNIFICADO -->
    <header class="app-header d-flex align-items-center justify-content-between">
        <div class="d-flex align-items-center gap-3">
            <img src="{{ url_for('static', filename='logo.png') }}" alt="Logo" height="32" style="opacity:0.8">
            <div>
                <div class="fw-bold fs-5 text-white" style="line-height:1;">SISTEMA UPS MANAGER</div>
                <small style="color:var(--accent-red); letter-spacing:2px; font-size:0.7rem;">CONSOLA DE
                    INGENIERÍA</small>
            </div>
        </div>
        <nav class="d-flex gap-4">
            <a href="{{ url_for('dashboard.dashboard') }}" class="nav-link"><i class="bi bi-speedometer2 me-1"></i>
                TABLERO</a>
            <a href="{{ url_for('calculator.calculadora') }}" class="nav-link"><i class="bi bi-calculator me-1"></i>
                CÁLCULOS</a>
            <a href="{{ url_for('management.gestion') }}" class="nav-link active"><i class="bi bi-database me-1"></i>
                DATOS</a>
            <a href="{{ url_for('monitoreo.index') }}" class="nav-link"><i class="bi bi-activity me-1"></i> SCADA</a>
        </nav>
        <div class="d-flex align-items-center gap-3">
            <div class="text-end">
                <div class="fw-bold" id="clock">00:00:00</div>
                <small class="text-muted text-uppercase" id="date">YYYY-MM-DD</small>
            </div>
        </div>
    </header>

    <div class="container-fluid p-0">
        {% if msg %}
        <div class="alert alert-info alert-dismissible fade show m-3" role="alert">
            {{ msg }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        {% endif %}

        {% if error_logs %}
        <div class="alert alert-danger alert-dismissible fade show m-3" role="alert">
            <strong>Detalles del error de carga:</strong>
            <ul>
                {% for log in error_logs %}
                <li>{{ log }}</li>
                {% endfor %}
            </ul>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        {% endif %}

        <div class="row g-0">
            <!-- SIDEBAR IZQUIERDO -->
            <div class="col-md-2 sidebar-container">
                <div class="nav flex-column nav-pills sidebar-nav" id="v-pills-tab" role="tablist"
                    aria-orientation="vertical">
                    <button class="nav-link {% if active_tab == 'ups' %}active{% endif %}" id="v-pills-ups-tab"
                        data-bs-toggle="pill" data-bs-target="#v-pills-ups" type="button" role="tab"><i
                            class="fas fa-server"></i> GESTIÓN UPS</button>
                    <button class="nav-link {% if active_tab == 'baterias' %}active{% endif %}"
                        id="v-pills-batteries-tab" data-bs-toggle="pill" data-bs-target="#v-pills-batteries"
                        type="button" role="tab"><i class="fas fa-car-battery"></i> BATERÍAS</button>
                    <button class="nav-link {% if active_tab == 'clientes' %}active{% endif %}" id="v-pills-clients-tab"
                        data-bs-toggle="pill" data-bs-target="#v-pills-clients" type="button" role="tab"><i
                            class="fas fa-users"></i> CLIENTES</button>
                    <button class="nav-link {% if active_tab == 'personal' %}active{% endif %}"
                        id="v-pills-personal-tab" data-bs-toggle="pill" data-bs-target="#v-pills-personal" type="button"
                        role="tab"><i class="fas fa-id-badge"></i> PERSONAL</button>
                    <button class="nav-link {% if active_tab == 'ventilacion' %}active{% endif %}"
                        id="v-pills-ventilacion-tab" data-bs-toggle="pill" data-bs-target="#v-pills-ventilacion"
                        type="button" role="tab"><i class="fas fa-wind"></i> VENTILACIÓN</button>
                    <button class="nav-link {% if active_tab == 'history' %}active{% endif %}" id="v-pills-history-tab"
                        data-bs-toggle="pill" data-bs-target="#v-pills-history" type="button" role="tab"><i
                            class="fas fa-history"></i> HISTORIAL</button>
                    <button class="nav-link {% if active_tab == 'carga' %}active{% endif %}" id="v-pills-carga-tab"
                        data-bs-toggle="pill" data-bs-target="#v-pills-carga" type="button" role="tab"><i
                            class="fas fa-cloud-upload-alt"></i> CARGA MASIVA</button>
                    <button class="nav-link {% if active_tab == 'personal' %}active{% endif %}"
                        id="v-pills-personal-tab" data-bs-toggle="pill" data-bs-target="#v-pills-personal" type="button"
                        role="tab"><i class="fas fa-user-tie"></i> PERSONAL</button>
                </div>
            </div>

            <!-- CONTENIDO DERECHA -->
            <div class="col-md-10 content-container">
                <div class="tab-content" id="v-pills-tabContent">

                    <!-- PESTAÑA 1: UPS (LISTA + EDICIÓN) -->
                    <div class="tab-pane fade {% if active_tab == 'ups' %}show active{% endif %}" id="v-pills-ups"
                        role="tabpanel">
                        {% if ups_seleccionado or agregando_ups %}
                        <!-- FORMULARIO COMPLETO (EDICIÓN / CREACIÓN) -->
                        <div class="tech-matrix">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <h4 class="m-0 fw-bold">
                                    {% if ups_seleccionado %}
                                    Editando: <span class="text-primary">{{ ups_seleccionado.Nombre_del_Producto
                                        }}</span>
                                    {% else %}
                                    <span class="text-success"><i class="fas fa-plus-circle"></i> Nuevo Equipo
                                        UPS</span>
                                    {% endif %}
                                </h4>
                                <form method="POST" style="display:inline;">
                                    <input type="hidden" name="accion" value="cancelar_edicion_ups">
                                    <button class="btn btn-secondary btn-sm"><i class="fas fa-arrow-left"></i> Volver a
                                        Lista</button>
                                </form>
                            </div>

                            <form method="POST" enctype="multipart/form-data">
                                <input type="hidden" name="accion" value="guardar_ups">
                                {% if ups_seleccionado %}
                                <input type="hidden" name="id" value="{{ ups_seleccionado.id }}">
                                {% endif %}

                                <!-- 1. DATOS GENERALES -->
                                <div class="control-title">1. Datos Generales</div>
                                <div class="row g-3 mb-3">
                                    <div class="col-md-3">
                                        <label class="small" style="color: #ff8a80;">Fabricante / Serie</label>
                                        <input type="text" name="Serie" class="form-control"
                                            value="{{ ups_seleccionado.Serie if ups_seleccionado else '' }}" required>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="small" style="color: #ff8a80;">Modelo (Nombre)</label>
                                        <input type="text" name="Nombre_del_Producto" class="form-control"
                                            value="{{ ups_seleccionado.Nombre_del_Producto if ups_seleccionado else '' }}"
                                            required>
                                    </div>
                                    <div class="col-md-2">
                                        <label class="small" style="color: #ff8a80;">Capacidad (kVA)</label>
                                        <input type="number" step="0.1" name="Capacidad_kVA" class="form-control"
                                            value="{{ ups_seleccionado.Capacidad_kVA if ups_seleccionado else '' }}"
                                            required>
                                    </div>
                                    <div class="col-md-2">
                                        <label class="small" style="color: #ff8a80;">Capacidad (kW)</label>
                                        <input type="number" step="0.1" name="Capacidad_kW" class="form-control"
                                            value="{{ ups_seleccionado.Capacidad_kW if ups_seleccionado else '' }}"
                                            required>
                                    </div>
                                    <div class="col-md-2">
                                        <label class="small" style="color: #ff8a80;">FP Salida</label>
                                        <input type="number" step="0.01" name="FP_Salida" class="form-control"
                                            value="{{ ups_seleccionado.FP_Salida if ups_seleccionado else '' }}">
                                    </div>
                                </div>

                                <!-- 2. ENTRADA -->
                                <div class="control-title">2. Especificaciones de Entrada</div>
                                <div class="row g-3 mb-3">
                                    <div class="col-md-2">
                                        <label class="small" style="color: #ff8a80;">Voltaje 1 (V)</label>
                                        <input type="number" name="Voltaje_Entrada_1_V" class="form-control"
                                            value="{{ ups_seleccionado.Voltaje_Entrada_1_V if ups_seleccionado else '' }}">
                                    </div>
                                    <div class="col-md-2">
                                        <label class="small" style="color: #ff8a80;">Voltaje 2 (V)</label>
                                        <input type="number" name="Voltaje_Entrada_2_V" class="form-control"
                                            value="{{ ups_seleccionado.Voltaje_Entrada_2_V if ups_seleccionado else '' }}">
                                    </div>
                                    <div class="col-md-2">
                                        <label class="small" style="color: #ff8a80;">Voltaje 3 (V)</label>
                                        <input type="number" name="Voltaje_Entrada_3_V" class="form-control"
                                            value="{{ ups_seleccionado.Voltaje_Entrada_3_V if ups_seleccionado else '' }}">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="small" style="color: #ff8a80;">Conexión Entrada</label>
                                        <input type="text" name="Conexion_Entrada" class="form-control"
                                            value="{{ ups_seleccionado.Conexion_Entrada if ups_seleccionado else '' }}"
                                            placeholder="Ej. 3P+N+PE">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="small" style="color: #ff8a80;">Rango Frec. (Hz)</label>
                                        <div class="input-group">
                                            <input type="number" name="Frecuencia_1_Hz" class="form-control"
                                                value="{{ ups_seleccionado.Frecuencia_1_Hz if ups_seleccionado else '' }}"
                                                placeholder="Min">
                                            <span class="input-group-text">-</span>
                                            <input type="number" name="Frecuencia_2_Hz" class="form-control"
                                                value="{{ ups_seleccionado.Frecuencia_2_Hz if ups_seleccionado else '' }}"
                                                placeholder="Max">
                                        </div>
                                    </div>
                                </div>
                                <div class="row g-3 mb-3">
                                    <div class="col-md-3">
                                        <label class="small" style="color: #ff8a80;">THDi Lineal (%)</label>
                                        <input type="number" step="0.1" name="THDu_Lineal_pct" class="form-control"
                                            value="{{ ups_seleccionado.THDu_Lineal_pct if ups_seleccionado else '' }}">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="small" style="color: #ff8a80;">THDi No Lineal (%)</label>
                                        <input type="number" step="0.1" name="THDu_NoLineal_pct" class="form-control"
                                            value="{{ ups_seleccionado.THDu_NoLineal_pct if ups_seleccionado else '' }}">
                                    </div>
                                </div>

                                <!-- 3. SALIDA -->
                                <div class="control-title">3. Especificaciones de Salida</div>
                                <div class="row g-3 mb-3">
                                    <div class="col-md-2">
                                        <label class="small" style="color: #ff8a80;">Voltaje 1 (V)</label>
                                        <input type="number" name="Voltaje_Salida_1_V" class="form-control"
                                            value="{{ ups_seleccionado.Voltaje_Salida_1_V if ups_seleccionado else '' }}">
                                    </div>
                                    <div class="col-md-2">
                                        <label class="small" style="color: #ff8a80;">Voltaje 2 (V)</label>
                                        <input type="number" name="Voltaje_Salida_2_V" class="form-control"
                                            value="{{ ups_seleccionado.Voltaje_Salida_2_V if ups_seleccionado else '' }}">
                                    </div>
                                    <div class="col-md-2">
                                        <label class="small" style="color: #ff8a80;">Voltaje 3 (V)</label>
                                        <input type="number" name="Voltaje_Salida_3_V" class="form-control"
                                            value="{{ ups_seleccionado.Voltaje_Salida_3_V if ups_seleccionado else '' }}">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="small" style="color: #ff8a80;">Conexión Salida</label>
                                        <input type="text" name="Conexion_Salida" class="form-control"
                                            value="{{ ups_seleccionado.Conexion_Salida if ups_seleccionado else '' }}">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="small" style="color: #ff8a80;">Precisión Voltaje (%)</label>
                                        <input type="number" step="0.1" name="Precision_Voltaje_pct"
                                            class="form-control"
                                            value="{{ ups_seleccionado.Precision_Voltaje_pct if ups_seleccionado else '' }}">
                                    </div>
                                </div>
                                <div class="row g-3 mb-3">
                                    <div class="col-md-4">
                                        <label class="small" style="color: #ff8a80;">Sobrecarga 110% (min)</label>
                                        <input type="number" step="0.1" name="Sobrecarga_110_pct_min"
                                            class="form-control"
                                            value="{{ ups_seleccionado.Sobrecarga_110_pct_min if ups_seleccionado else '' }}">
                                    </div>
                                    <div class="col-md-4">
                                        <label class="small" style="color: #ff8a80;">Sobrecarga 125% (min)</label>
                                        <input type="number" step="0.1" name="Sobrecarga_125_pct_min"
                                            class="form-control"
                                            value="{{ ups_seleccionado.Sobrecarga_125_pct_min if ups_seleccionado else '' }}">
                                    </div>
                                    <div class="col-md-4">
                                        <label class="small" style="color: #ff8a80;">Sobrecarga 150% (min)</label>
                                        <input type="number" step="0.1" name="Sobrecarga_150_pct_min"
                                            class="form-control"
                                            value="{{ ups_seleccionado.Sobrecarga_150_pct_min if ups_seleccionado else '' }}">
                                    </div>
                                </div>

                                <!-- 4. EFICIENCIA Y BATERÍA -->
                                <div class="control-title">4. Eficiencia y Baterías</div>
                                <div class="row g-3 mb-3">
                                    <div class="col-md-2">
                                        <label class="small" style="color: #ff8a80;">Efic. AC (%)</label>
                                        <input type="number" step="0.1" name="Eficiencia_Modo_AC_pct"
                                            class="form-control"
                                            value="{{ ups_seleccionado.Eficiencia_Modo_AC_pct if ups_seleccionado else '' }}">
                                    </div>
                                    <div class="col-md-2">
                                        <label class="small" style="color: #ff8a80;">Efic. Bat (%)</label>
                                        <input type="number" step="0.1" name="Eficiencia_Modo_Bateria_pct"
                                            class="form-control"
                                            value="{{ ups_seleccionado.Eficiencia_Modo_Bateria_pct if ups_seleccionado else '' }}">
                                    </div>
                                    <div class="col-md-2">
                                        <label class="small" style="color: #ff8a80;">Efic. ECO (%)</label>
                                        <input type="number" step="0.1" name="Eficiencia_Modo_ECO_pct"
                                            class="form-control"
                                            value="{{ ups_seleccionado.Eficiencia_Modo_ECO_pct if ups_seleccionado else '' }}">
                                    </div>
                                    <div class="col-md-2">
                                        <label class="small" style="color: #ff8a80;">Bus DC (V)</label>
                                        <input type="number" name="Bateria_Vdc" class="form-control"
                                            value="{{ ups_seleccionado.Bateria_Vdc if ups_seleccionado else '' }}">
                                    </div>
                                    <div class="col-md-4">
                                        <label class="small" style="color: #ff8a80;">Piezas Batería
                                            (Min/Max/Def)</label>
                                        <div class="input-group">
                                            <input type="number" name="Bateria_Piezas_min" class="form-control"
                                                value="{{ ups_seleccionado.Bateria_Piezas_min if ups_seleccionado else '' }}"
                                                placeholder="Min">
                                            <input type="number" name="Bateria_Piezas_max" class="form-control"
                                                value="{{ ups_seleccionado.Bateria_Piezas_max if ups_seleccionado else '' }}"
                                                placeholder="Max">
                                            <input type="number" name="Bateria_Piezas_defecto" class="form-control"
                                                value="{{ ups_seleccionado.Bateria_Piezas_defecto if ups_seleccionado else '' }}"
                                                placeholder="Def">
                                        </div>
                                    </div>
                                </div>

                                <!-- 5. FÍSICO Y AMBIENTAL -->
                                <div class="control-title">5. Físico y Ambiental</div>
                                <div class="row g-3 mb-4">
                                    <div class="col-md-3">
                                        <label class="small" style="color: #ff8a80;">Dimensiones (LxAxA mm)</label>
                                        <div class="input-group">
                                            <input type="number" name="Dim_Largo_mm" class="form-control"
                                                value="{{ ups_seleccionado.Dim_Largo_mm if ups_seleccionado else '' }}"
                                                placeholder="L">
                                            <input type="number" name="Dim_Ancho_mm" class="form-control"
                                                value="{{ ups_seleccionado.Dim_Ancho_mm if ups_seleccionado else '' }}"
                                                placeholder="A">
                                            <input type="number" name="Dim_Alto_mm" class="form-control"
                                                value="{{ ups_seleccionado.Dim_Alto_mm if ups_seleccionado else '' }}"
                                                placeholder="H">
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                        <label class="small" style="color: #ff8a80;">Peso (kg)</label>
                                        <input type="number" step="0.1" name="Peso_Gabinete_kg" class="form-control"
                                            value="{{ ups_seleccionado.Peso_Gabinete_kg if ups_seleccionado else '' }}">
                                    </div>
                                    <div class="col-md-2">
                                        <label class="small" style="color: #ff8a80;">Ruido (dB)</label>
                                        <input type="number" name="Nivel_Ruido_dB" class="form-control"
                                            value="{{ ups_seleccionado.Nivel_Ruido_dB if ups_seleccionado else '' }}">
                                    </div>
                                    <div class="col-md-2">
                                        <label class="small" style="color: #ff8a80;">Temp (°C)</label>
                                        <div class="input-group">
                                            <input type="number" name="TempTrabajo_min_C" class="form-control"
                                                value="{{ ups_seleccionado.TempTrabajo_min_C if ups_seleccionado else '' }}"
                                                placeholder="Min">
                                            <input type="number" name="TempTrabajo_max_C" class="form-control"
                                                value="{{ ups_seleccionado.TempTrabajo_max_C if ups_seleccionado else '' }}"
                                                placeholder="Max">
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="small" style="color: #ff8a80;">Humedad (%)</label>
                                        <div class="input-group">
                                            <input type="number" name="Humedad_min_pct" class="form-control"
                                                value="{{ ups_seleccionado.Humedad_min_pct if ups_seleccionado else '' }}"
                                                placeholder="Min">
                                            <input type="number" name="Humedad_max_pct" class="form-control"
                                                value="{{ ups_seleccionado.Humedad_max_pct if ups_seleccionado else '' }}"
                                                placeholder="Max">
                                        </div>
                                    </div>
                                </div>

                                <div class="row g-3 mb-4">
                                    <div class="col-md-9">
                                        <label class="small" style="color: #ff8a80;">Imagen del Equipo
                                            (Principal)</label>
                                        <input type="file" name="imagen_ups" class="form-control">
                                    </div>
                                    <div class="col-md-3">
                                        {% if ups_seleccionado and ups_seleccionado.imagen_url %}
                                        <img src="{{ url_for('static', filename='img/ups/' + ups_seleccionado.imagen_url) }}"
                                            class="img-fluid rounded" alt="Imagen actual">
                                        {% else %}
                                        <div
                                            class="border rounded bg-dark text-white-50 d-flex align-items-center justify-content-center h-100">
                                            Sin Imagen</div>
                                        {% endif %}
                                    </div>
                                </div>

                                <div class="control-title">6. Imagenes Adicionales para Reporte</div>
                                <div class="row g-3 mb-4">
                                    <div class="col-md-6">
                                        <label class="small" style="color: #ff8a80;">Imagen de Notas de
                                            Instalación</label>
                                        <input type="file" name="imagen_instalacion" class="form-control">
                                        {% if ups_seleccionado and ups_seleccionado.imagen_instalacion_url %}
                                        <div class="mt-2 text-center">
                                            <img src="{{ url_for('static', filename='img/ups/' + ups_seleccionado.imagen_instalacion_url) }}"
                                                class="img-fluid rounded" style="max-height: 100px;"
                                                alt="Imagen Notas Inst.">
                                            <p class="small text-muted mb-0">{{ ups_seleccionado.imagen_instalacion_url
                                                }}</p>
                                        </div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-6">
                                        <label class="small" style="color: #ff8a80;">Imagen de Conexión de
                                            Baterías</label>
                                        <input type="file" name="imagen_baterias" class="form-control">
                                        {% if ups_seleccionado and ups_seleccionado.imagen_baterias_url %}
                                        <div class="mt-2 text-center">
                                            <img src="{{ url_for('static', filename='img/ups/' + ups_seleccionado.imagen_baterias_url) }}"
                                                class="img-fluid rounded" style="max-height: 100px;"
                                                alt="Imagen Conexión Bat.">
                                            <p class="small text-muted mb-0">{{ ups_seleccionado.imagen_baterias_url }}
                                            </p>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>

                                <!-- TIPO DE VENTILACIÓN -->
                                <div class="control-title">9. Tipo de Ventilación</div>
                                <div class="row g-3 mb-3">
                                    <div class="col-md-6">
                                        <label class="small" style="color: #ff8a80;">Tipo de Ventilación</label>
                                        <select name="tipo_ventilacion_id" class="form-select">
                                            <option value="">-- Seleccionar Tipo --</option>
                                            {% for tv in tipos_ventilacion %}
                                            <option value="{{ tv.id }}" {% if ups_seleccionado and
                                                ups_seleccionado.tipo_ventilacion_id==tv.id %}selected{% endif %}>
                                                {{ tv.nombre }}
                                            </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>

                                <div class="d-flex justify-content-end gap-2">
                                    <button type="submit" class="btn btn-success fw-bold px-5"><i
                                            class="fas fa-save"></i> GUARDAR EQUIPO</button>
                                </div>
                            </form>
                        </div>
                        {% else %}
                        <!-- LISTA DE UPS -->
                        <div class="tech-matrix">
                            <div class="d-flex justify-content-between align-items-center mb-3 border-bottom pb-2">
                                <div class="control-title mb-0 border-0 pb-0"><i class="fas fa-server me-2"></i>
                                    CATÁLOGO DE EQUIPOS UPS</div>
                                <div>
                                    <form method="POST" style="display:inline;">
                                        <input type="hidden" name="accion" value="iniciar_agregar_ups">
                                        <button class="btn btn-sm btn-success fw-bold"><i class="fas fa-plus"></i>
                                            Agregar Nuevo Equipo</button>
                                    </form>
                                    <a href="{{ url_for('management.exportar_tabla', tabla='ups_specs') }}"
                                        class="btn btn-sm btn-outline-info ms-2"><i class="fas fa-download"></i>
                                        Exportar CSV</a>
                                </div>
                            </div>

                            <div style="height: 600px; overflow-y: auto;">
                                <table class="table table-sm table-hover">
                                    <thead>
                                        <tr>
                                            <th>Serie / Fabricante</th>
                                            <th>Modelo</th>
                                            <th>kVA</th>
                                            <th>Voltaje (In/Out)</th>
                                            <th>Dimensiones (mm)</th>
                                            <th class="text-center">Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for u in ups %}
                                        <tr>
                                            <td>{{ u.Serie }}</td>
                                            <td>{{ u.Nombre_del_Producto }}</td>
                                            <td>{{ u.Capacidad_kVA }}</td>
                                            <td>{{ u.Voltaje_Entrada_1_V }} / {{ u.Voltaje_Salida_1_V }}</td>
                                            <td class="small">{{ u.Dim_Largo_mm }}x{{ u.Dim_Ancho_mm }}x{{ u.Dim_Alto_mm
                                                }}</td>
                                            <td class="text-center">
                                                <!-- BOTÓN EDITAR INTEGRADO -->
                                                <form method="POST" style="display:inline;">
                                                    <input type="hidden" name="accion" value="editar_ups">
                                                    <input type="hidden" name="id_ups" value="{{ u.id }}">
                                                    <button class="btn btn-warning btn-sm me-2" title="Editar"><i
                                                            class="fas fa-edit"></i></button>
                                                </form>
                                                <!-- BOTÓN ELIMINAR -->
                                                <form method="POST" style="display:inline;"
                                                    onsubmit="return confirm('¿Estás seguro de eliminar este equipo?');">
                                                    <input type="hidden" name="tipo" value="del_ups">
                                                    <input type="hidden" name="id" value="{{ u.id }}">
                                                    <button class="btn btn-danger btn-sm" title="Eliminar"><i
                                                            class="fas fa-trash"></i></button>
                                                </form>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        {% endif %}
                    </div>

                    <!-- PESTAÑA 2: BATERÍAS (LISTA + EDICIÓN) -->
                    <div class="tab-pane fade {% if active_tab == 'baterias' %}show active{% endif %}"
                        id="v-pills-batteries" role="tabpanel">
                        {% if bateria_seleccionada or agregando_bateria %}
                        <!-- EDICIÓN / CREACIÓN BATERÍA -->
                        <div class="tech-matrix">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <h4 class="m-0 fw-bold">
                                    {% if bateria_seleccionada %}
                                    Editando: <span class="text-primary">{{ bateria_seleccionada.modelo }}</span>
                                    {% else %}
                                    <span class="text-success"><i class="fas fa-plus-circle"></i> Nueva Batería</span>
                                    {% endif %}
                                </h4>
                                <div class="d-flex gap-2">
                                    <form method="POST" style="display:inline;">
                                        <input type="hidden" name="accion" value="cancelar_edicion_bateria">
                                        <button class="btn btn-secondary btn-sm"><i class="fas fa-arrow-left"></i>
                                            Volver</button>
                                    </form>
                                </div>
                            </div>
                            <form method="POST">
                                <input type="hidden" name="accion" value="guardar_bateria">
                                {% if bateria_seleccionada %}
                                <input type="hidden" name="id" value="{{ bateria_seleccionada.id }}">
                                {% endif %}

                                <!-- 1. DATOS GENERALES -->
                                <div class="control-title">1. Datos Generales</div>
                                <div class="row g-3 mb-3">
                                    <div class="col-md-3">
                                        <label class="small" style="color: #ff8a80;">Modelo</label>
                                        <input type="text" name="modelo" class="form-control"
                                            value="{{ bateria_seleccionada.modelo if bateria_seleccionada else '' }}"
                                            required>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="small" style="color: #ff8a80;">Serie</label>
                                        <input type="text" name="serie" class="form-control"
                                            value="{{ bateria_seleccionada.serie if bateria_seleccionada else '' }}">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="small" style="color: #ff8a80;">Voltaje (V)</label>
                                        <input type="number" step="0.1" name="voltaje_nominal" class="form-control"
                                            value="{{ bateria_seleccionada.voltaje_nominal if bateria_seleccionada else '' }}"
                                            required>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="small" style="color: #ff8a80;">Capacidad (Ah)</label>
                                        <input type="number" step="0.1" name="capacidad_nominal_ah" class="form-control"
                                            value="{{ bateria_seleccionada.capacidad_nominal_ah if bateria_seleccionada else '' }}"
                                            required>
                                    </div>
                                </div>

                                <!-- 2. FÍSICO -->
                                <div class="control-title">2. Características Físicas</div>
                                <div class="row g-3 mb-3">
                                    <div class="col-md-3">
                                        <label class="small" style="color: #ff8a80;">Dimensiones (LxAxA mm)</label>
                                        <div class="input-group">
                                            <input type="number" name="largo_mm" class="form-control"
                                                value="{{ bateria_seleccionada.largo_mm if bateria_seleccionada else '' }}"
                                                placeholder="L">
                                            <input type="number" name="ancho_mm" class="form-control"
                                                value="{{ bateria_seleccionada.ancho_mm if bateria_seleccionada else '' }}"
                                                placeholder="A">
                                            <input type="number" name="alto_total_mm" class="form-control"
                                                value="{{ bateria_seleccionada.alto_total_mm if bateria_seleccionada else '' }}"
                                                placeholder="H">
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                        <label class="small" style="color: #ff8a80;">Peso (kg)</label>
                                        <input type="number" step="0.1" name="peso_kg" class="form-control"
                                            value="{{ bateria_seleccionada.peso_kg if bateria_seleccionada else '' }}">
                                    </div>
                                    <div class="col-md-2">
                                        <label class="small" style="color: #ff8a80;">Terminal</label>
                                        <input type="text" name="tipo_terminal" class="form-control"
                                            value="{{ bateria_seleccionada.tipo_terminal if bateria_seleccionada else '' }}">
                                    </div>
                                    <div class="col-md-2">
                                        <label class="small" style="color: #ff8a80;">Material</label>
                                        <input type="text" name="material_contenedor" class="form-control"
                                            value="{{ bateria_seleccionada.material_contenedor if bateria_seleccionada else '' }}">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="small" style="color: #ff8a80;">Resistencia (mΩ)</label>
                                        <input type="number" step="0.1" name="resistencia_interna_mohm"
                                            class="form-control"
                                            value="{{ bateria_seleccionada.resistencia_interna_mohm if bateria_seleccionada else '' }}">
                                    </div>
                                </div>

                                <!-- 3. PARÁMETROS DE CARGA -->
                                <div class="control-title">3. Parámetros de Carga y Temperatura</div>
                                <div class="row g-3 mb-4">
                                    <div class="col-md-3">
                                        <label class="small" style="color: #ff8a80;">Flotación (V)</label>
                                        <div class="input-group">
                                            <input type="number" step="0.01" name="carga_flotacion_v_min"
                                                class="form-control"
                                                value="{{ bateria_seleccionada.carga_flotacion_v_min if bateria_seleccionada else '' }}"
                                                placeholder="Min">
                                            <input type="number" step="0.01" name="carga_flotacion_v_max"
                                                class="form-control"
                                                value="{{ bateria_seleccionada.carga_flotacion_v_max if bateria_seleccionada else '' }}"
                                                placeholder="Max">
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="small" style="color: #ff8a80;">Cíclica (V)</label>
                                        <div class="input-group">
                                            <input type="number" step="0.01" name="carga_ciclica_v_min"
                                                class="form-control"
                                                value="{{ bateria_seleccionada.carga_ciclica_v_min if bateria_seleccionada else '' }}"
                                                placeholder="Min">
                                            <input type="number" step="0.01" name="carga_ciclica_v_max"
                                                class="form-control"
                                                value="{{ bateria_seleccionada.carga_ciclica_v_max if bateria_seleccionada else '' }}"
                                                placeholder="Max">
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                        <label class="small" style="color: #ff8a80;">Max Descarga (A)</label>
                                        <input type="number" step="0.1" name="max_corriente_descarga_5s_a"
                                            class="form-control"
                                            value="{{ bateria_seleccionada.max_corriente_descarga_5s_a if bateria_seleccionada else '' }}">
                                    </div>
                                    <div class="col-md-2">
                                        <label class="small" style="color: #ff8a80;">Autodescarga (Meses)</label>
                                        <input type="number" name="autodescarga_meses_max" class="form-control"
                                            value="{{ bateria_seleccionada.autodescarga_meses_max if bateria_seleccionada else '' }}">
                                    </div>
                                    <div class="col-md-2">
                                        <label class="small" style="color: #ff8a80;">Temp. Nominal (°C)</label>
                                        <input type="number" name="temp_nominal_c" class="form-control"
                                            value="{{ bateria_seleccionada.temp_nominal_c if bateria_seleccionada else '' }}">
                                    </div>
                                </div>

                                <div class="d-flex justify-content-end gap-2">
                                    <button type="submit" class="btn btn-success fw-bold px-5"><i
                                            class="fas fa-save"></i> GUARDAR BATERÍA</button>
                                </div>
                            </form>
                        </div>

                        {% if bateria_seleccionada %}
                        <!-- SECCIÓN DE CURVAS Y EDICIÓN -->
                        <form method="POST" enctype="multipart/form-data">
                            <div class="tech-matrix">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <div class="control-title mb-0">Curvas de Descarga</div>

                                    <!-- Selector de Unidad -->
                                    <div class="btn-group" role="group">
                                        <button type="submit" name="accion" value="cambiar_unidad_curva_W"
                                            class="btn btn-sm {% if unidad_curva == 'W' %}btn-primary{% else %}btn-outline-light{% endif %}">
                                            Watts / Celda
                                        </button>
                                        <button type="submit" name="accion" value="cambiar_unidad_curva_A"
                                            class="btn btn-sm {% if unidad_curva == 'A' %}btn-primary{% else %}btn-outline-light{% endif %}">
                                            Amperes
                                        </button>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-lg-5">
                                        <div class="p-0" style="max-height: 400px; overflow-y: auto;">
                                            <table class="table table-sm mb-0 text-center" style="font-size: 0.85rem;">
                                                <thead class="sticky-top">
                                                    <tr>
                                                        <th>Tiempo (min)</th>
                                                        {% if pivot_data %}
                                                        {% for v in pivot_data.headers %}
                                                        <th>FV {{ v }}</th>
                                                        {% endfor %}
                                                        {% else %}
                                                        <th>Sin Datos</th>
                                                        {% endif %}
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% if pivot_data %}
                                                    {% for row in pivot_data.data %}
                                                    <tr>
                                                        <td class="fw-bold align-middle">{{ row.tiempo }}</td>
                                                        {% for v in pivot_data.headers %}
                                                        <td>
                                                            <input type="number" step="0.01"
                                                                class="form-control form-control-sm"
                                                                name="curva-{{ row.tiempo }}-{{ v }}"
                                                                value="{{ row[v] if row[v] is not none else '' }}">
                                                        </td>
                                                        {% endfor %}
                                                    </tr>
                                                    {% endfor %}
                                                    {% else %}
                                                    <tr>
                                                        <td colspan="10" class="text-center py-3">Sin curvas cargadas
                                                            para la unidad seleccionada ({{ unidad_curva }}).</td>
                                                    </tr>
                                                    {% endif %}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                    <div class="col-lg-7">
                                        <div style="height: 400px; width: 100%;">
                                            <canvas id="curvasChart"></canvas>
                                        </div>
                                    </div>
                                </div>

                                <input type="hidden" name="id" value="{{ bateria_seleccionada.id }}">
                                <input type="hidden" name="unidad_curva" value="{{ unidad_curva }}">

                                <div
                                    class="mt-3 pt-3 border-top border-secondary d-flex justify-content-between align-items-center">
                                    <!-- Botón para guardar la edición manual -->
                                    <div>
                                        <button type="submit" name="accion" value="guardar_curvas"
                                            class="btn btn-success"><i class="fas fa-save me-2"></i>Guardar Curvas
                                            Editadas</button>
                                    </div>

                                    <!-- Formulario para subir nuevo archivo CSV -->
                                    <div class="d-flex align-items-center">
                                        <label class="small text-muted me-2">O reemplazar con CSV:</label>
                                        <input type="file" name="archivo_csv" class="form-control form-control-sm"
                                            accept=".csv">
                                        <button type="submit" name="accion" value="subir_curvas"
                                            class="btn btn-warning btn-sm ms-2">Subir</button>
                                    </div>
                                </div>
                            </div>
                        </form>
                        {% endif %}

                        {% else %}
                        <!-- LISTA BATERÍAS -->
                        <div class="tech-matrix">
                            <div class="d-flex justify-content-between align-items-center mb-3 border-bottom pb-2">
                                <div class="control-title mb-0 border-0 pb-0"><i class="fas fa-car-battery me-2"></i>
                                    CATÁLOGO DE BATERÍAS</div>
                                <div>
                                    <form method="POST" style="display:inline;">
                                        <input type="hidden" name="accion" value="iniciar_agregar_bateria">
                                        <button class="btn btn-sm btn-success fw-bold"><i class="fas fa-plus"></i>
                                            Agregar Nueva Batería</button>
                                    </form>
                                    <a href="{{ url_for('management.exportar_tabla', tabla='baterias_modelos') }}"
                                        class="btn btn-sm btn-outline-info ms-2"><i class="fas fa-download"></i>
                                        Exportar CSV</a>
                                </div>
                            </div>

                            <div style="height: 600px; overflow-y: auto;">
                                <table class="table table-sm table-hover">
                                    <thead>
                                        <tr>
                                            <th>Modelo</th>
                                            <th>Voltaje</th>
                                            <th>Capacidad (Ah)</th>
                                            <th>Dimensiones</th>
                                            <th>Peso</th>
                                            <th class="text-center">Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for b in baterias %}
                                        <tr>
                                            <td>{{ b.modelo }}</td>
                                            <td>{{ b.voltaje_nominal }} V</td>
                                            <td>{{ b.capacidad_nominal_ah }} Ah</td>
                                            <td class="small">{{ b.largo_mm }}x{{ b.ancho_mm }}x{{ b.alto_total_mm }}
                                            </td>
                                            <td>{{ b.peso_kg }} kg</td>
                                            <td class="text-center">
                                                <form method="POST" style="display:inline;">
                                                    <input type="hidden" name="accion" value="editar_bateria">
                                                    <input type="hidden" name="id_bateria" value="{{ b.id }}">
                                                    <button class="btn btn-warning btn-sm me-2" title="Editar"><i
                                                            class="fas fa-edit"></i></button>
                                                </form>
                                                <form method="POST" style="display:inline;"
                                                    onsubmit="return confirm('¿Eliminar batería?');">
                                                    <input type="hidden" name="tipo" value="del_bateria">
                                                    <input type="hidden" name="id" value="{{ b.id }}">
                                                    <button class="btn btn-danger btn-sm" title="Eliminar"><i
                                                            class="fas fa-trash"></i></button>
                                                </form>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        {% endif %}
                    </div>

                    <!-- PESTAÑA 3: CLIENTES -->
                    <div class="tab-pane fade {% if active_tab == 'clientes' %}show active{% endif %}"
                        id="v-pills-clients" role="tabpanel">
                        <div class="tech-matrix">
                            <div class="d-flex justify-content-between align-items-center mb-3 border-bottom pb-2">
                                <div class="control-title mb-0 border-0 pb-0"><i class="fas fa-users me-2"></i> GESTIÓN
                                    DE CLIENTES Y SUCURSALES</div>
                                <a href="{{ url_for('management.exportar_tabla', tabla='clientes') }}"
                                    class="btn btn-sm btn-outline-info"><i class="fas fa-download"></i> Exportar CSV</a>
                            </div>
                            <form method="POST" class="row g-2 mb-3 p-2 border rounded"
                                style="background: rgba(255,255,255,0.05); border-color: rgba(255,255,255,0.1) !important;">
                                <input type="hidden" name="tipo" value="add_cliente">
                                <div class="col-3"><input type="text" name="cliente"
                                        class="form-control form-control-sm" placeholder="Cliente" required></div>
                                <div class="col-3"><input type="text" name="sucursal"
                                        class="form-control form-control-sm" placeholder="Sucursal" required></div>
                                <div class="col-2"><input type="text" name="direccion"
                                        class="form-control form-control-sm" placeholder="Dirección"></div>
                                <div class="col-2"><input type="text" name="lat" class="form-control form-control-sm"
                                        placeholder="Lat, Lon"></div>
                                <div class="col-2"><button class="btn btn-sm btn-success w-100">Agregar</button></div>
                            </form>
                            <div style="height: 600px; overflow-y: auto;">
                                <table class="table table-sm table-hover">
                                    <thead>
                                        <tr>
                                            <th>Cliente</th>
                                            <th>Sucursal</th>
                                            <th class="text-center">Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for c in clientes %}
                                        <tr>
                                            <td>{{ c.cliente }}</td>
                                            <td>{{ c.sucursal }}</td>
                                            <td class="text-center">
                                                <button class="btn btn-info btn-sm me-2" data-cliente="{{ c.cliente }}"
                                                    data-sucursal="{{ c.sucursal }}" data-direccion="{{ c.direccion }}"
                                                    data-lat="{{ c.lat }}" data-lon="{{ c.lon }}"
                                                    onclick="verCliente(this)" title="Ver Detalles y Mapa">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                                <form method="POST" style="display:inline;"
                                                    onsubmit="return confirm('¿Eliminar cliente?');">
                                                    <input type="hidden" name="tipo" value="del_cliente">
                                                    <input type="hidden" name="id" value="{{ c.id }}">
                                                    <button class="btn btn-danger btn-sm" title="Eliminar"><i
                                                            class="fas fa-trash"></i></button>
                                                </form>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- PESTAÑA PERSONAL (NUEVO) -->
                    <div class="tab-pane fade {% if active_tab == 'personal' %}show active{% endif %}"
                        id="v-pills-personal" role="tabpanel">

                        {% if personal_seleccionado %}
                        <!-- FORMULARIO DE EDICIÓN PERSONAL -->
                        <div class="tech-matrix">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <h4 class="m-0 fw-bold">Editando: <span class="text-primary">{{
                                        personal_seleccionado.nombre }}</span></h4>
                                <form method="POST" style="display:inline;">
                                    <input type="hidden" name="tipo" value="cancelar_edit_personal">
                                    <button class="btn btn-secondary btn-sm"><i class="fas fa-arrow-left"></i> Volver a
                                        Lista</button>
                                </form>
                            </div>

                            <form method="POST">
                                <input type="hidden" name="tipo" value="update_personal">
                                <input type="hidden" name="id" value="{{ personal_seleccionado.id }}">

                                <div class="row g-3 mb-3">
                                    <div class="col-md-6">
                                        <label class="small" style="color: #ff8a80;">Nombre Completo</label>
                                        <input type="text" name="nombre" class="form-control"
                                            value="{{ personal_seleccionado.nombre }}" required>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="small" style="color: #ff8a80;">Puesto / Cargo</label>
                                        <input type="text" name="puesto" class="form-control"
                                            value="{{ personal_seleccionado.puesto }}" required>
                                    </div>
                                </div>

                                <div class="d-flex justify-content-end gap-2">
                                    <button type="submit" class="btn btn-success fw-bold px-5"><i
                                            class="fas fa-save"></i> GUARDAR CAMBIOS</button>
                                </div>
                            </form>
                        </div>
                        {% else %}

                        <!-- LISTA DE PERSONAL -->
                        <div class="tech-matrix">
                            <div class="d-flex justify-content-between align-items-center mb-3 border-bottom pb-2">
                                <div class="control-title mb-0 border-0 pb-0"><i class="fas fa-id-badge me-2"></i> LISTA
                                    DE PERSONAL</div>
                                <a href="{{ url_for('management.exportar_tabla', tabla='personal') }}"
                                    class="btn btn-sm btn-outline-info"><i class="fas fa-download"></i> Exportar CSV</a>
                            </div>

                            <!-- Formulario de Agregado Rápido -->
                            <form method="POST" class="row g-2 mb-3 p-2 border rounded"
                                style="background: rgba(255,255,255,0.05); border-color: rgba(255,255,255,0.1) !important;">
                                <input type="hidden" name="tipo" value="add_personal">
                                <div class="col-5">
                                    <input type="text" name="nombre" class="form-control form-control-sm"
                                        placeholder="Nombre Completo" required>
                                </div>
                                <div class="col-5">
                                    <input type="text" name="puesto" class="form-control form-control-sm"
                                        placeholder="Puesto / Cargo" required>
                                </div>
                                <div class="col-2">
                                    <button class="btn btn-sm btn-success w-100"><i class="fas fa-plus"></i>
                                        Agregar</button>
                                </div>
                            </form>

                            <div style="height: 600px; overflow-y: auto;">
                                <table class="table table-sm table-hover">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>Nombre Completo</th>
                                            <th>Puesto / Cargo</th>
                                            <th class="text-center">Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for p in personal %}
                                        <tr>
                                            <td>{{ p.id }}</td>
                                            <td>{{ p.nombre }}</td>
                                            <td>{{ p.puesto }}</td>
                                            <td class="text-center">
                                                <form method="POST" style="display:inline;">
                                                    <input type="hidden" name="tipo" value="edit_personal">
                                                    <input type="hidden" name="id_personal" value="{{ p.id }}">
                                                    <button class="btn btn-warning btn-sm me-2" title="Editar"><i
                                                            class="fas fa-edit"></i></button>
                                                </form>
                                                <form method="POST" style="display:inline;"
                                                    onsubmit="return confirm('¿Eliminar a {{ p.nombre }}?');">
                                                    <input type="hidden" name="tipo" value="del_personal">
                                                    <input type="hidden" name="id" value="{{ p.id }}">
                                                    <button class="btn btn-danger btn-sm" title="Eliminar"><i
                                                            class="fas fa-trash"></i></button>
                                                </form>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        {% endif %}
                    </div>

                    <!-- PESTAÑA 3.5: TIPOS DE VENTILACIÓN -->
                    <div class="tab-pane fade {% if active_tab == 'ventilacion' %}show active{% endif %}"
                        id="v-pills-ventilacion" role="tabpanel">
                        {% if tipo_vent_seleccionado %}
                        <!-- FORMULARIO DE EDICIÓN -->
                        <div class="tech-matrix">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <h4 class="m-0 fw-bold">Editando: <span class="text-primary">{{
                                        tipo_vent_seleccionado.nombre }}</span></h4>
                                <form method="POST" style="display:inline;">
                                    <input type="hidden" name="tipo" value="cancelar_edit_tipo_vent">
                                    <button class="btn btn-secondary btn-sm"><i class="fas fa-arrow-left"></i> Volver a
                                        Lista</button>
                                </form>
                            </div>

                            <form method="POST" enctype="multipart/form-data">
                                <input type="hidden" name="tipo" value="update_tipo_vent">
                                <input type="hidden" name="id" value="{{ tipo_vent_seleccionado.id }}">

                                <div class="control-title">Datos del Tipo de Ventilación</div>
                                <div class="row g-3 mb-3">
                                    <div class="col-md-4">
                                        <label class="small" style="color: #ff8a80;">Nombre *</label>
                                        <input type="text" name="nombre" class="form-control"
                                            value="{{ tipo_vent_seleccionado.nombre }}" required>
                                    </div>
                                    <div class="col-md-8">
                                        <label class="small" style="color: #ff8a80;">Descripción</label>
                                        <input type="text" name="descripcion" class="form-control"
                                            value="{{ tipo_vent_seleccionado.descripcion or '' }}">
                                    </div>
                                </div>

                                <div class="row g-3 mb-4">
                                    <div class="col-md-9">
                                        <label class="small" style="color: #ff8a80;">Imagen de Referencia</label>
                                        <input type="file" name="imagen_ventilacion" class="form-control"
                                            accept="image/*,.svg">
                                        <small class="text-muted">Formato: PNG, JPG, SVG. Máximo 5MB</small>
                                    </div>
                                    <div class="col-md-3">
                                        {% if tipo_vent_seleccionado.imagen_url %}
                                        <img src="{{ url_for('static', filename='img/ups/' + tipo_vent_seleccionado.imagen_url) }}"
                                            class="img-fluid rounded" alt="Imagen actual">
                                        {% else %}
                                        <div
                                            class="border rounded bg-dark text-white-50 d-flex align-items-center justify-content-center h-100">
                                            Sin Imagen</div>
                                        {% endif %}
                                    </div>
                                </div>

                                <div class="d-flex justify-content-end gap-2">
                                    <button type="submit" class="btn btn-success fw-bold px-5"><i
                                            class="fas fa-save"></i> GUARDAR CAMBIOS</button>
                                </div>
                            </form>
                        </div>
                        {% else %}
                        <!-- LISTA DE TIPOS -->
                        <div class="tech-matrix">
                            <div class="d-flex justify-content-between align-items-center mb-3 border-bottom pb-2">
                                <div class="control-title mb-0 border-0 pb-0"><i class="fas fa-wind me-2"></i> TIPOS DE
                                    VENTILACIÓN</div>
                                <a href="{{ url_for('management.exportar_tabla', tabla='tipos_ventilacion') }}"
                                    class="btn btn-sm btn-outline-info"><i class="fas fa-download"></i> Exportar CSV</a>
                            </div>

                            <form method="POST" enctype="multipart/form-data" class="row g-2 mb-3 p-2 border rounded"
                                style="background: rgba(255,255,255,0.05); border-color: rgba(255,255,255,0.1) !important;">
                                <input type="hidden" name="tipo" value="add_tipo_vent">
                                <div class="col-3">
                                    <input type="text" name="nombre" class="form-control form-control-sm"
                                        placeholder="Nombre (ej: Aire Forzado)" required>
                                </div>
                                <div class="col-4">
                                    <input type="text" name="descripcion" class="form-control form-control-sm"
                                        placeholder="Descripción (opcional)">
                                </div>
                                <div class="col-3">
                                    <input type="file" name="imagen_ventilacion" class="form-control form-control-sm"
                                        accept="image/*,.svg">
                                </div>
                                <div class="col-2">
                                    <button class="btn btn-sm btn-success w-100"><i class="fas fa-plus"></i>
                                        Agregar</button>
                                </div>
                            </form>

                            <div style="max-height: 500px; overflow-y: auto;">
                                <table class="table table-sm table-hover">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>Nombre</th>
                                            <th>Descripción</th>
                                            <th>Imagen</th>
                                            <th class="text-center">Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for tv in tipos_ventilacion %}
                                        <tr>
                                            <td>{{ tv.id }}</td>
                                            <td><strong>{{ tv.nombre }}</strong></td>
                                            <td><small>{{ tv.descripcion or '-' }}</small></td>
                                            <td>
                                                {% if tv.imagen_url %}
                                                <img src="{{ url_for('static', filename='img/ups/' + tv.imagen_url) }}"
                                                    style="height: 40px; width: auto;" alt="Imagen">
                                                {% else %}
                                                <span class="text-muted">-</span>
                                                {% endif %}
                                            </td>
                                            <td class="text-center">
                                                <form method="POST" style="display:inline;">
                                                    <input type="hidden" name="tipo" value="edit_tipo_vent">
                                                    <input type="hidden" name="id_tipo_vent" value="{{ tv.id }}">
                                                    <button class="btn btn-warning btn-sm me-2" title="Editar"><i
                                                            class="fas fa-edit"></i></button>
                                                </form>
                                                <form method="POST" style="display:inline;"
                                                    onsubmit="return confirm('¿Eliminar este tipo de ventilación?');">
                                                    <input type="hidden" name="tipo" value="del_tipo_vent">
                                                    <input type="hidden" name="id" value="{{ tv.id }}">
                                                    <button class="btn btn-danger btn-sm" title="Eliminar"><i
                                                            class="fas fa-trash"></i></button>
                                                </form>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        {% endif %}
                    </div>

                    <!-- PESTAÑA 4: HISTORIAL -->
                    <div class="tab-pane fade {% if active_tab == 'history' %}show active{% endif %}"
                        id="v-pills-history" role="tabpanel">
                        <div class="tech-matrix">
                            <div class="d-flex justify-content-between align-items-center mb-3 border-bottom pb-2">
                                <div class="control-title mb-0 border-0 pb-0" style="color: var(--success);"><i
                                        class="fas fa-history me-2"></i> PROYECTOS PUBLICADOS (HISTORIAL)</div>
                                <a href="{{ url_for('management.exportar_tabla', tabla='proyectos_publicados') }}"
                                    class="btn btn-sm btn-outline-info"><i class="fas fa-download"></i> Exportar CSV</a>
                            </div>
                            <div style="max-height: 600px; overflow-y: auto;">
                                <table class="table table-sm table-bordered">
                                    <thead>
                                        <tr>
                                            <th>Pedido</th>
                                            <th>Fecha</th>
                                            <th>Cliente</th>
                                            <th>Modelo (Snapshot)</th>
                                            <th>Cables</th>
                                            <th>Config</th>
                                            <th class="text-center">Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for p in proyectos %}
                                        <tr>
                                            <td>{{ p.pedido }}</td>
                                            <td>{{ p.fecha_publicacion }}</td>
                                            <td>{{ p.cliente_snap }} - {{ p.sucursal_snap }}</td>
                                            <td>{{ p.modelo_snap }}</td>
                                            <td>{{ p.calibre_fases }}</td>
                                            <td>{{ p.config_salida }}</td>
                                            <tdclass="text-center">
                                                <button class="btn btn-warning btn-sm me-2" title="Editar"
                                                    onclick="editarProyecto('{{ p.pedido }}', '{{ p.cliente_snap }}', '{{ p.sucursal_snap }}')">
                                                    <i class="fas fa-edit"></i> Editar
                                                </button>
                                                <button class="btn btn-danger btn-sm" title="Eliminar"
                                                    onclick="eliminarProyecto('{{ p.pedido }}')">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                                </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- PESTAÑA 5: CARGA MASIVA -->
                    <div class="tab-pane fade {% if active_tab == 'carga' %}show active{% endif %}" id="v-pills-carga"
                        role="tabpanel">
                        <div class="row g-4">
                            <!-- 1. UPS -->
                            <div class="col-md-6 col-lg-3">
                                <div class="card-control h-100 text-center d-flex flex-column justify-content-center">
                                    <div class="mb-3" style="font-size: 2.5rem; color: var(--text-sec);"><i
                                            class="fas fa-server"></i></div>
                                    <h6 class="fw-bold mb-2">Catálogo UPS</h6>
                                    <div class="d-grid gap-2">
                                        <a href="{{ url_for('management.descargar_plantilla', tipo='ups') }}"
                                            class="btn btn-outline-light btn-sm">Plantilla</a>
                                        <form method="POST" enctype="multipart/form-data">
                                            <input type="hidden" name="tipo_carga" value="ups">
                                            <input type="file" name="archivo_csv" id="csv_ups" class="d-none"
                                                accept=".csv" onchange="this.form.submit()">
                                            <button type="button" class="btn btn-primary btn-sm w-100"
                                                onclick="document.getElementById('csv_ups').click()">Subir CSV</button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                            <!-- 2. CLIENTES -->
                            <div class="col-md-6 col-lg-3">
                                <div class="card-control h-100 text-center d-flex flex-column justify-content-center">
                                    <div class="mb-3" style="font-size: 2.5rem; color: var(--text-sec);"><i
                                            class="fas fa-users"></i></div>
                                    <h6 class="fw-bold mb-2">Clientes</h6>
                                    <div class="d-grid gap-2">
                                        <a href="{{ url_for('management.descargar_plantilla', tipo='clientes') }}"
                                            class="btn btn-outline-light btn-sm">Plantilla</a>
                                        <form method="POST" enctype="multipart/form-data">
                                            <input type="hidden" name="tipo_carga" value="clientes">
                                            <input type="file" name="archivo_csv" id="csv_cli" class="d-none"
                                                accept=".csv" onchange="this.form.submit()">
                                            <button type="button" class="btn btn-primary btn-sm w-100"
                                                onclick="document.getElementById('csv_cli').click()">Subir CSV</button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                            <!-- 3. BATERÍAS MODELOS -->
                            <div class="col-md-6 col-lg-3">
                                <div class="card-control h-100 text-center d-flex flex-column justify-content-center">
                                    <div class="mb-3" style="font-size: 2.5rem; color: var(--text-sec);"><i
                                            class="fas fa-car-battery"></i></div>
                                    <h6 class="fw-bold mb-2">Modelos Baterías</h6>
                                    <div class="d-grid gap-2">
                                        <a href="{{ url_for('management.descargar_plantilla', tipo='baterias_modelos') }}"
                                            class="btn btn-outline-light btn-sm">Plantilla</a>
                                        <form method="POST" enctype="multipart/form-data">
                                            <input type="hidden" name="tipo_carga" value="baterias_modelos">
                                            <input type="file" name="archivo_csv" id="csv_bat" class="d-none"
                                                accept=".csv" onchange="this.form.submit()">
                                            <button type="button" class="btn btn-primary btn-sm w-100"
                                                onclick="document.getElementById('csv_bat').click()">Subir CSV</button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                            <!-- 4. CURVAS -->
                            <div class="col-md-6 col-lg-3">
                                <div class="card-control h-100 text-center d-flex flex-column justify-content-center">
                                    <div class="mb-3" style="font-size: 2.5rem; color: var(--text-sec);"><i
                                            class="fas fa-chart-line"></i></div>
                                    <h6 class="fw-bold mb-2">Curvas Descarga</h6>
                                    <div class="d-grid gap-2">
                                        <a href="{{ url_for('management.descargar_plantilla', tipo='baterias_curvas') }}"
                                            class="btn btn-outline-light btn-sm">Plantilla</a>
                                        <form method="POST" enctype="multipart/form-data">
                                            <input type="hidden" name="tipo_carga" value="baterias_curvas">
                                            <input type="file" name="archivo_csv" id="csv_cur" class="d-none"
                                                accept=".csv" onchange="this.form.submit()">
                                            <button type="button" class="btn btn-primary btn-sm w-100"
                                                onclick="document.getElementById('csv_cur').click()">Subir CSV</button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- PESTAÑA 6: PERSONAL -->
                    <div class="tab-pane fade {% if active_tab == 'personal' %}show active{% endif %}"
                        id="v-pills-personal" role="tabpanel">
                        {% if personal_seleccionado or agregando_personal %}
                        <!-- FORMULARIO EDICION/CREACION PERSONAL -->
                        <div class="tech-matrix">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <h4 class="m-0 fw-bold">
                                    {% if personal_seleccionado %}
                                    Editando: <span class="text-primary">{{ personal_seleccionado.nombre }}</span>
                                    {% else %}
                                    <span class="text-success"><i class="fas fa-plus-circle"></i> Nuevo Personal</span>
                                    {% endif %}
                                </h4>
                                <form method="POST" style="display:inline;">
                                    <input type="hidden" name="accion" value="cancelar_edicion_personal">
                                    <button class="btn btn-secondary btn-sm"><i class="fas fa-arrow-left"></i>
                                        Volver</button>
                                </form>
                            </div>
                            <form method="POST">
                                <input type="hidden" name="accion" value="guardar_personal">
                                {% if personal_seleccionado %}
                                <input type="hidden" name="id" value="{{ personal_seleccionado.id }}">
                                {% endif %}

                                <div class="row g-3 mb-3">
                                    <div class="col-md-6">
                                        <label class="small" style="color: #ff8a80;">Nombre Completo</label>
                                        <input type="text" name="nombre" class="form-control"
                                            value="{{ personal_seleccionado.nombre if personal_seleccionado else '' }}"
                                            required>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="small" style="color: #ff8a80;">Puesto</label>
                                        <input type="text" name="puesto" class="form-control"
                                            value="{{ personal_seleccionado.puesto if personal_seleccionado else '' }}"
                                            required>
                                    </div>
                                </div>

                                <div class="d-flex justify-content-end gap-2">
                                    <button type="submit" class="btn btn-success fw-bold px-5"><i
                                            class="fas fa-save"></i> GUARDAR</button>
                                </div>
                            </form>
                        </div>
                        {% else %}
                        <!-- LISTA PERSONAL -->
                        <div class="tech-matrix">
                            <div class="d-flex justify-content-between align-items-center mb-3 border-bottom pb-2">
                                <div class="control-title mb-0 border-0 pb-0"><i class="fas fa-user-tie me-2"></i>
                                    DIRECTORIO DE PERSONAL</div>
                                <div>
                                    <form method="POST" style="display:inline;">
                                        <input type="hidden" name="accion" value="iniciar_agregar_personal">
                                        <button class="btn btn-sm btn-success fw-bold"><i class="fas fa-plus"></i>
                                            Agregar Personal</button>
                                    </form>
                                </div>
                            </div>

                            <div style="height: 600px; overflow-y: auto;">
                                <table class="table table-sm table-hover">
                                    <thead>
                                        <tr>
                                            <th>Nombre</th>
                                            <th>Puesto</th>
                                            <th class="text-center">Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% if personal %}
                                        {% for p in personal %}
                                        <tr>
                                            <td>{{ p.nombre }}</td>
                                            <td>{{ p.puesto }}</td>
                                            <td class="text-center">
                                                <form method="POST" style="display:inline;">
                                                    <input type="hidden" name="accion" value="editar_personal">
                                                    <input type="hidden" name="id_personal" value="{{ p.id }}">
                                                    <button class="btn btn-warning btn-sm me-2" title="Editar"><i
                                                            class="fas fa-edit"></i></button>
                                                </form>
                                                <form method="POST" style="display:inline;"
                                                    onsubmit="return confirm('¿Eliminar personal?');">
                                                    <input type="hidden" name="tipo" value="del_personal">
                                                    <input type="hidden" name="id" value="{{ p.id }}">
                                                    <button class="btn btn-danger btn-sm" title="Eliminar"><i
                                                            class="fas fa-trash"></i></button>
                                                </form>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                        {% else %}
                                        <tr>
                                            <td colspan="3" class="text-center text-muted">No hay personal registrado.
                                            </td>
                                        </tr>
                                        {% endif %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL DETALLES CLIENTE (POPUP) -->
    <div class="modal fade" id="clienteModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content"
                style="background: rgba(30, 30, 30, 0.95); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); color: #fff;">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title fw-bold" id="modalClienteTitle"><i class="fas fa-building me-2"></i> Detalles
                        del Cliente</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-5">
                            <h6 class="text-danger fw-bold mb-3 border-bottom border-secondary pb-2">INFORMACIÓN</h6>
                            <p class="mb-2"><strong class="d-block small" style="color: #ff8a80;">CLIENTE</strong> <span
                                    id="modalClienteNombre" class="fs-5 fw-bold"></span></p>
                            <p class="mb-2"><strong class="d-block small" style="color: #ff8a80;">SUCURSAL</strong>
                                <span id="modalClienteSucursal" class="fs-6"></span>
                            </p>
                            <p class="mb-2"><strong class="d-block small" style="color: #ff8a80;">DIRECCIÓN</strong></p>
                            <div class="p-2 rounded mb-3" style="background: rgba(0,0,0,0.3); font-size: 0.9rem;"
                                id="modalClienteDireccion"></div>
                        </div>
                        <div class="col-md-7">
                            <h6 class="text-danger fw-bold mb-3 border-bottom border-secondary pb-2">UBICACIÓN
                                GEOGRÁFICA</h6>
                            <div
                                style="width: 100%; height: 300px; background: #111; border-radius: 12px; overflow: hidden; border: 1px solid rgba(255,255,255,0.1);">
                                <iframe id="modalMapFrame" width="100%" height="100%" frameborder="0" style="border:0"
                                    allowfullscreen></iframe>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- FUNCIONES PARA PROYECTOS PUBLICADOS ---
        function editarProyecto(pedido, cliente, sucursal) {
            // Redirigir a la calculadora con el pedido para editar
            if (confirm(`¿Editar proyecto del pedido ${pedido}?`)) {
                window.location.href = `/calculadora?pedido=${encodeURIComponent(pedido)}`;
            }
        }

        function eliminarProyecto(pedido) {
            if (confirm(`¿ELIMINAR el proyecto del pedido ${pedido}?\n\nEsta acción no se puede deshacer.`)) {
                // Crear formulario para enviar DELETE request
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '/eliminar-proyecto';

                const inputPedido = document.createElement('input');
                inputPedido.type = 'hidden';
                inputPedido.name = 'pedido';
                inputPedido.value = pedido;
                form.appendChild(inputPedido);

                document.body.appendChild(form);
                form.submit();
            }
        }

        // --- FUNCIONES PARA CLIENTES ---
        function verCliente(btn) {
            const d = btn.dataset;
            document.getElementById('modalClienteTitle').innerHTML = `<i class="fas fa-building me-2"></i> ${d.cliente} - ${d.sucursal}`;
            document.getElementById('modalClienteNombre').textContent = d.cliente;
            document.getElementById('modalClienteSucursal').textContent = d.sucursal;
            document.getElementById('modalClienteDireccion').textContent = d.direccion || 'Sin dirección registrada';

            const mapFrame = document.getElementById('modalMapFrame');
            if (d.lat && d.lon) {
                // Carga dinámica del mapa usando las coordenadas del botón
                mapFrame.src = `https://maps.google.com/maps?q=${d.lat},${d.lon}&hl=es&z=15&output=embed`;
            } else {
                mapFrame.src = "about:blank";
            }

            new bootstrap.Modal(document.getElementById('clienteModal')).show();
        }
    </script>

    <!-- Script para Gráfica de Baterías -->
    {% if pivot_data %}
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const ctx = document.getElementById('curvasChart').getContext('2d');
            const headers = {{ pivot_data.headers | tojson
        }};
        const dataRows = {{ pivot_data.data | tojson }};

        const labels = dataRows.map(row => row.tiempo);

        const datasets = headers.map((fv, index) => {
            // Generar colores dinámicos (HSL) para diferenciar las líneas de voltaje
            const hue = (index * 360 / headers.length) % 360;
            const color = `hsl(${hue}, 70%, 60%)`;

            return {
                label: `FV ${fv}`,
                data: dataRows.map(row => row[fv] || null),
                borderColor: color,
                backgroundColor: color,
                tension: 0.3,
                pointRadius: 3
            };
        });

        new Chart(ctx, {
            type: 'line',
            data: { labels: labels, datasets: datasets },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { labels: { color: '#a1a1a6' } },
                    title: { display: true, text: 'Curvas de Descarga ({{ unidad_curva }})', color: '#f5f5f7' }
                },
                scales: {
                    x: {
                        title: { display: true, text: 'Tiempo (min)', color: '#a1a1a6' },
                        ticks: { color: '#a1a1a6' },
                        grid: { color: 'rgba(255,255,255,0.1)' }
                    },
                    y: {
                        title: { display: true, text: '{{ "Watts/Celda" if unidad_curva == "W" else "Amperes" }}', color: '#a1a1a6' },
                        ticks: { color: '#a1a1a6' },
                        grid: { color: 'rgba(255,255,255,0.1)' }
                    }
                }
            }
        });
        });
    </script>
    {% endif %}

    <!-- Bootstrap JS para funcionamiento de Tabs -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
</body>

</html>