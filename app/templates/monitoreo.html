<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitoreo - Sistema UPS Manager</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .device-card {
            background: rgba(30, 30, 30, 0.6);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
        }

        .device-card:hover {
            border-color: var(--accent-red);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .status-dot {
            height: 12px;
            width: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }

        .status-online {
            background-color: #2ecc71;
            box-shadow: 0 0 10px #2ecc71;
        }

        .status-offline {
            background-color: #e74c3c;
            box-shadow: 0 0 5px #e74c3c;
        }

        .metric-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #fff;
        }

        .metric-label {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.6);
        }
    </style>
</head>

<body>
    <header class="app-header">
        <div class="d-flex align-items-center gap-3">
            <img src="{{ url_for('static', filename='logo.png') }}" alt="Logo" height="40">
            <span style="font-weight:700; font-size:1.2rem; letter-spacing:1px; color: #fff;">SISTEMA UPS <span
                    style="color:var(--accent-red)">MANAGER</span></span>
        </div>
        <nav class="nav-links">
            <a href="{{ url_for('dashboard.dashboard') }}" class="nav-link"><i class="bi bi-speedometer2 me-1"></i>
                DASHBOARD</a>
            <a href="{{ url_for('calculator.calculadora') }}" class="nav-link"><i class="bi bi-calculator me-1"></i>
                CALCULADORA</a>
            <a href="{{ url_for('management.gestion') }}" class="nav-link"><i class="bi bi-database me-1"></i> GESTIÓN
                BD</a>
            <a href="{{ url_for('monitoreo.index') }}" class="nav-link active"><i class="bi bi-activity me-1"></i>
                MONITOREO</a>
        </nav>
    </header>

    <div class="container-fluid p-4">
        <div class="row">
            <!-- Sidebar: Lista de Dispositivos -->
            <div class="col-md-3">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="text-white m-0">Dispositivos</h5>
                    <button class="btn btn-sm btn-outline-success" data-bs-toggle="modal"
                        data-bs-target="#addDeviceModal">
                        <i class="bi bi-plus-lg"></i>
                    </button>
                </div>
                <div id="deviceList">
                    <!-- Cards de dispositivos se inyectarán aquí -->
                    <div class="text-center text-muted mt-5">
                        <div class="spinner-border text-secondary" role="status"></div>
                        <p class="mt-2">Cargando...</p>
                    </div>
                </div>
            </div>

            <!-- Main: Detalles y Gráficas -->
            <div class="col-md-9">
                <div id="dashboardView" class="text-center text-muted mt-5 fade-in">
                    <i class="bi bi-activity" style="font-size: 4rem; opacity: 0.2;"></i>
                    <h3 class="mt-3">Panel en Tiempo Real</h3>
                    <p>Seleccione un dispositivo o espere datos...</p>
                </div>

                <div id="monitorPanel" style="display:none;">
                    <div
                        class="d-flex justify-content-between align-items-end mb-4 border-bottom border-secondary pb-2">
                        <div>
                            <h2 class="text-white mb-0" id="currentDevName">UPS Principal</h2>
                            <small class="text-muted" id="currentDevIp">192.168.1.100</small>
                        </div>
                        <div id="currentDevStatus" class="badge bg-success">ONLINE</div>
                    </div>

                    <!-- Métricas Principales -->
                    <div class="row g-3 mb-4">
                        <div class="col-md-4">
                            <div class="device-card text-center p-3">
                                <div class="metric-label">VOLTAJE ENTRADA</div>
                                <div class="metric-value"><span id="val_vin">--</span> V</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="device-card text-center p-3">
                                <div class="metric-label">VOLTAJE SALIDA</div>
                                <div class="metric-value"><span id="val_vout">--</span> V</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="device-card text-center p-3">
                                <div class="metric-label">CARGA</div>
                                <div class="metric-value"><span id="val_load">--</span> %</div>
                                <div class="progress mt-2" style="height: 4px; background: rgba(255,255,255,0.1);">
                                    <div id="prog_load" class="progress-bar bg-info" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="device-card text-center p-3">
                                <div class="metric-label">BATERÍA</div>
                                <div class="metric-value"><span id="val_bat">--</span> %</div>
                                <div class="progress mt-2" style="height: 4px; background: rgba(255,255,255,0.1);">
                                    <div id="prog_bat" class="progress-bar bg-success" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="device-card text-center p-3">
                                <div class="metric-label">TEMPERATURA</div>
                                <div class="metric-value"><span id="val_temp">--</span> °C</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="device-card text-center p-3">
                                <div class="metric-label">VOLTAJE BATERÍA</div>
                                <div class="metric-value"><span id="val_vbat">--</span> V</div>
                            </div>
                        </div>
                    </div>

                    <!-- Gráficas -->
                    <div class="row g-3">
                        <div class="col-md-8">
                            <div class="device-card h-100">
                                <h6 class="text-muted mb-3">Histórico de Voltaje (Últimos 10 min)</h6>
                                <canvas id="chartVoltaje"></canvas>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="device-card h-100">
                                <h6 class="text-muted mb-3">Estado de Batería</h6>
                                <canvas id="chartBateria"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Agregar Dispositivo (Rediseñado) -->
    <div class="modal fade" id="addDeviceModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content"
                style="background: rgba(30,30,30,0.95); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 0 50px rgba(0,0,0,0.5);">
                <div class="modal-header border-bottom border-dark">
                    <h5 class="modal-title font-monospace fw-bold text-white"><i
                            class="bi bi-hdd-network me-2 text-danger"></i>AGREGAR DISPOSITIVO</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <form id="addDeviceForm">
                        <!-- Sección Identificación -->
                        <div class="mb-4">
                            <label class="form-label text-white-50 small text-uppercase fw-bold">Identificación del
                                Equipo</label>
                            <div class="input-group">
                                <span class="input-group-text bg-dark border-secondary text-secondary"><i
                                        class="bi bi-tag-fill"></i></span>
                                <input type="text" class="form-control bg-dark text-white border-secondary" id="devName"
                                    placeholder="Ej: UPS Servidor Central" required>
                            </div>
                            <div class="form-text text-white-50 small">Un nombre descriptivo para identificar este UPS
                                en el dashboard.</div>
                        </div>

                        <!-- Sección Conexión -->
                        <div class="mb-2">
                            <label class="form-label text-white-50 small text-uppercase fw-bold">Parámetros de Conexión
                                (Modbus TCP)</label>
                        </div>

                        <div class="row g-3">
                            <div class="col-md-12">
                                <div class="input-group">
                                    <span class="input-group-text bg-dark border-secondary text-secondary"><i
                                            class="bi bi-globe"></i></span>
                                    <input type="text" class="form-control bg-dark text-white border-secondary"
                                        id="devIp" placeholder="192.168.x.x o 10.147.x.x" required>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label text-white-50 small">Puerto TCP</label>
                                <div class="input-group">
                                    <span class="input-group-text bg-dark border-secondary text-secondary"><i
                                            class="bi bi-door-open"></i></span>
                                    <input type="number" class="form-control bg-dark text-white border-secondary"
                                        id="devPort" value="502">
                                </div>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label text-white-50 small">Modbus Slave ID</label>
                                <div class="input-group">
                                    <span class="input-group-text bg-dark border-secondary text-secondary"><i
                                            class="bi bi-person-badge"></i></span>
                                    <input type="number" class="form-control bg-dark text-white border-secondary"
                                        id="devSlave" value="1">
                                </div>
                            </div>
                        </div>

                        <div class="alert alert-dark border-secondary mt-4 d-flex align-items-center" role="alert">
                            <i class="bi bi-info-circle-fill text-info me-3 fs-4"></i>
                            <div class="small text-muted">
                                Asegúrate de que el dispositivo esté accesible en la red ZeroTier o Local antes de
                                guardar.
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer border-top border-dark p-3">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-danger px-4 fw-bold" onclick="addDevice()">
                        <i class="bi bi-plus-lg me-2"></i>GUARDAR DISPOSITIVO
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const socket = io();
        let devices = {}; // Store device data
        let currentDevId = null;
        let chartV = null;
        let chartB = null;

        // Init Charts
        function initCharts() {
            const ctxV = document.getElementById('chartVoltaje').getContext('2d');
            chartV = new Chart(ctxV, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Entrada (V)',
                        borderColor: '#3498db',
                        data: [],
                        tension: 0.4
                    }, {
                        label: 'Salida (V)',
                        borderColor: '#2ecc71',
                        data: [],
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    scales: { y: { beginAtZero: false, grid: { color: 'rgba(255,255,255,0.1)' } }, x: { display: false } },
                    plugins: { legend: { labels: { color: '#fff' } } }
                }
            });

            const ctxB = document.getElementById('chartBateria').getContext('2d');
            chartB = new Chart(ctxB, {
                type: 'doughnut',
                data: {
                    labels: ['Carga', 'Descarga'],
                    datasets: [{
                        data: [100, 0],
                        backgroundColor: ['#2ecc71', '#e74c3c'],
                        borderWidth: 0
                    }]
                },
                options: { cutout: '70%', plugins: { legend: { display: false } } }
            });
        }

        // Load devices list
        fetch('/api/monitoreo/list')
            .then(r => r.json())
            .then(data => {
                const container = document.getElementById('deviceList');
                container.innerHTML = '';
                data.forEach(dev => {
                    devices[dev.id] = dev; // Init cache
                    renderDeviceCard(dev);
                });
            });

        function renderDeviceCard(dev) {
            const container = document.getElementById('deviceList');
            // Check if exists
            let card = document.getElementById(`card-${dev.id}`);
            if (!card) {
                card = document.createElement('div');
                card.id = `card-${dev.id}`;
                card.className = 'device-card cursor-pointer';
                card.onclick = () => selectDevice(dev.id);
                container.appendChild(card);
            }

            const statusClass = dev.status === 'online' ? 'status-online' : 'status-offline';

            card.innerHTML = `
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="fw-bold text-white mb-1">${dev.nombre || dev.name}</div>
                        <div class="small text-muted">${dev.ip}</div>
                    </div>
                    <div>
                        <span class="status-dot ${statusClass}" id="status-${dev.id}"></span>
                        <button class="btn btn-sm btn-link text-danger p-0" onclick="deleteDevice(${dev.id}, event)"><i class="bi bi-trash"></i></button>
                    </div>
                </div>
            `;
        }

        function addDevice() {
            const data = {
                nombre: document.getElementById('devName').value,
                ip: document.getElementById('devIp').value,
                port: document.getElementById('devPort').value,
                slave_id: document.getElementById('devSlave').value
            };

            fetch('/api/monitoreo/add', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            }).then(r => {
                if (r.ok) location.reload();
                else alert('Error al agregar');
            });
        }

        function deleteDevice(id, e) {
            e.stopPropagation();
            if (confirm('¿Eliminar dispositivo?')) {
                fetch(`/api/monitoreo/delete/${id}`, { method: 'DELETE' })
                    .then(r => {
                        const card = document.getElementById(`card-${id}`);
                        if (card) card.remove();
                    });
            }
        }

        function selectDevice(id) {
            currentDevId = id;
            document.getElementById('dashboardView').style.display = 'none';
            document.getElementById('monitorPanel').style.display = 'block';

            const dev = devices[id];
            if (dev) {
                document.getElementById('currentDevName').textContent = dev.nombre || dev.name;
                document.getElementById('currentDevIp').textContent = dev.ip;
                // Clear charts or load history if implemented
                if (chartV) {
                    chartV.data.labels = [];
                    chartV.data.datasets.forEach(bs => bs.data = []);
                    chartV.update();
                }
            }
        }

        // Socket IO Events
        socket.on('ups_update', (data) => {
            // Update device list status
            const cardStatus = document.getElementById(`status-${data.id}`);
            if (cardStatus) {
                cardStatus.className = `status-dot ${data.status === 'online' ? 'status-online' : 'status-offline'}`;
            }

            // Cache data
            devices[data.id] = { ...devices[data.id], ...data };

            // Update details if selected
            if (currentDevId === data.id && data.data) {
                document.getElementById('currentDevStatus').textContent = data.status.toUpperCase();
                document.getElementById('currentDevStatus').className = `badge bg-${data.status === 'online' ? 'success' : 'danger'}`;

                document.getElementById('val_vin').textContent = data.data.voltaje_in || '--';
                document.getElementById('val_vout').textContent = data.data.voltaje_out || '--';
                document.getElementById('val_load').textContent = data.data.carga_pct || '--';
                document.getElementById('val_bat').textContent = data.data.bateria_pct || '--';
                document.getElementById('val_temp').textContent = data.data.temperatura || '--';
                document.getElementById('val_vbat').textContent = data.data.voltaje_bateria || '--';

                const bPct = data.data.bateria_pct || 0;
                const lPct = data.data.carga_pct || 0;

                document.getElementById('prog_bat').style.width = `${bPct}%`;
                document.getElementById('prog_load').style.width = `${lPct}%`;

                // Update Chart
                if (chartV) {
                    const now = new Date().toLocaleTimeString();
                    if (chartV.data.labels.length > 20) {
                        chartV.data.labels.shift();
                        chartV.data.datasets[0].data.shift();
                        chartV.data.datasets[1].data.shift();
                    }
                    chartV.data.labels.push(now);
                    chartV.data.datasets[0].data.push(data.data.voltaje_in);
                    chartV.data.datasets[1].data.push(data.data.voltaje_out);
                    chartV.update('none'); // Perf mode
                }

                if (chartB) {
                    chartB.data.datasets[0].data = [bPct, 100 - bPct];
                    chartB.update();
                }
            }
        });

        // Init
        initCharts();
    </script>
</body>

</html>