<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitoreo - Sistema UPS Manager</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .device-card {
            background: rgba(30, 30, 30, 0.6);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
        }

        .device-card:hover {
            border-color: var(--accent-red);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .status-dot {
            height: 12px;
            width: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }

        .status-online {
            background-color: #2ecc71;
            box-shadow: 0 0 10px #2ecc71;
        }

        .status-offline {
            background-color: #e74c3c;
            box-shadow: 0 0 5px #e74c3c;
        }

        .metric-value {
            font-size: 1.4rem;
            font-weight: 700;
            color: #fff;
        }

        .metric-label {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.6);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .metric-unit {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.5);
            font-weight: 400;
        }

        .section-title {
            font-size: 0.85rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            padding-bottom: 0.5rem;
            margin-bottom: 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .section-title i {
            margin-right: 0.5rem;
        }

        .phase-badge {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 4px;
        }

        .phase-l1 { background-color: #e74c3c; }
        .phase-l2 { background-color: #f39c12; }
        .phase-l3 { background-color: #3498db; }

        .metric-mini {
            font-size: 1rem;
            font-weight: 600;
            color: #fff;
        }

        .temp-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .temp-bar {
            height: 6px;
            border-radius: 3px;
            flex: 1;
            background: rgba(255,255,255,0.1);
            overflow: hidden;
        }

        .temp-bar-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.5s ease, background-color 0.5s ease;
        }
    </style>
</head>

<body>
    <header class="app-header">
        <div class="d-flex align-items-center gap-3">
            <img src="{{ url_for('static', filename='logo.png') }}" alt="Logo" height="40">
            <span style="font-weight:700; font-size:1.2rem; letter-spacing:1px; color: #fff;">SISTEMA UPS <span
                    style="color:var(--accent-red)">MANAGER</span></span>
        </div>
        <nav class="nav-links">
            <a href="{{ url_for('dashboard.dashboard') }}" class="nav-link"><i class="bi bi-speedometer2 me-1"></i>
                DASHBOARD</a>
            <a href="{{ url_for('calculator.calculadora') }}" class="nav-link"><i class="bi bi-calculator me-1"></i>
                CALCULADORA</a>
            <a href="{{ url_for('management.gestion') }}" class="nav-link"><i class="bi bi-database me-1"></i> GESTION
                BD</a>
            <a href="{{ url_for('monitoreo.index') }}" class="nav-link active"><i class="bi bi-activity me-1"></i>
                MONITOREO</a>
        </nav>
    </header>

    <div class="container-fluid p-4">
        <div class="row">
            <!-- Sidebar: Lista de Dispositivos -->
            <div class="col-md-2">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="text-white m-0">Dispositivos</h5>
                    <button class="btn btn-sm btn-outline-success" data-bs-toggle="modal"
                        data-bs-target="#addDeviceModal">
                        <i class="bi bi-plus-lg"></i>
                    </button>
                </div>
                <div id="deviceList">
                    <div class="text-center text-muted mt-5">
                        <div class="spinner-border text-secondary" role="status"></div>
                        <p class="mt-2">Cargando...</p>
                    </div>
                </div>
            </div>

            <!-- Main: Detalles y Graficas -->
            <div class="col-md-10">
                <div id="dashboardView" class="text-center text-muted mt-5 fade-in">
                    <i class="bi bi-activity" style="font-size: 4rem; opacity: 0.2;"></i>
                    <h3 class="mt-3">Panel en Tiempo Real</h3>
                    <p>Seleccione un dispositivo o espere datos...</p>
                </div>

                <div id="monitorPanel" style="display:none;">
                    <!-- Header del dispositivo -->
                    <div class="d-flex justify-content-between align-items-end mb-3 border-bottom border-secondary pb-2">
                        <div>
                            <h2 class="text-white mb-0" id="currentDevName">UPS Principal</h2>
                            <small class="text-muted" id="currentDevIp">192.168.1.100</small>
                        </div>
                        <div id="currentDevStatus" class="badge bg-success">ONLINE</div>
                    </div>

                    <!-- ============================================ -->
                    <!-- SECCION: VOLTAJES DE ENTRADA (por fase)      -->
                    <!-- ============================================ -->
                    <div class="section-title text-info"><i class="bi bi-box-arrow-in-right"></i>ENTRADA</div>
                    <div class="row g-2 mb-3">
                        <div class="col-md-2">
                            <div class="device-card text-center p-2">
                                <div class="metric-label"><span class="phase-badge phase-l1"></span>L1</div>
                                <div class="metric-value"><span id="val_vin_l1">--</span> <span class="metric-unit">V</span></div>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="device-card text-center p-2">
                                <div class="metric-label"><span class="phase-badge phase-l2"></span>L2</div>
                                <div class="metric-value"><span id="val_vin_l2">--</span> <span class="metric-unit">V</span></div>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="device-card text-center p-2">
                                <div class="metric-label"><span class="phase-badge phase-l3"></span>L3</div>
                                <div class="metric-value"><span id="val_vin_l3">--</span> <span class="metric-unit">V</span></div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="device-card text-center p-2">
                                <div class="metric-label"><i class="bi bi-activity me-1"></i>FRECUENCIA ENTRADA</div>
                                <div class="metric-value"><span id="val_freq_in">--</span> <span class="metric-unit">Hz</span></div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="device-card text-center p-2">
                                <div class="metric-label"><i class="bi bi-lightning me-1"></i>CARGA</div>
                                <div class="metric-value"><span id="val_load">--</span> <span class="metric-unit">%</span></div>
                                <div class="progress mt-1" style="height: 4px; background: rgba(255,255,255,0.1);">
                                    <div id="prog_load" class="progress-bar bg-info" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ============================================ -->
                    <!-- SECCION: VOLTAJES DE SALIDA (por fase)       -->
                    <!-- ============================================ -->
                    <div class="section-title text-success"><i class="bi bi-box-arrow-right"></i>SALIDA</div>
                    <div class="row g-2 mb-3">
                        <div class="col-md-2">
                            <div class="device-card text-center p-2">
                                <div class="metric-label"><span class="phase-badge phase-l1"></span>L1</div>
                                <div class="metric-value"><span id="val_vout_l1">--</span> <span class="metric-unit">V</span></div>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="device-card text-center p-2">
                                <div class="metric-label"><span class="phase-badge phase-l2"></span>L2</div>
                                <div class="metric-value"><span id="val_vout_l2">--</span> <span class="metric-unit">V</span></div>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="device-card text-center p-2">
                                <div class="metric-label"><span class="phase-badge phase-l3"></span>L3</div>
                                <div class="metric-value"><span id="val_vout_l3">--</span> <span class="metric-unit">V</span></div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="device-card text-center p-2">
                                <div class="metric-label"><i class="bi bi-activity me-1"></i>FRECUENCIA SALIDA</div>
                                <div class="metric-value"><span id="val_freq_out">--</span> <span class="metric-unit">Hz</span></div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="device-card text-center p-2">
                                <div class="metric-label"><i class="bi bi-arrow-right-circle me-1"></i>CORRIENTE SALIDA</div>
                                <div class="metric-value"><span id="val_iout">--</span> <span class="metric-unit">A</span></div>
                            </div>
                        </div>
                    </div>

                    <!-- ============================================ -->
                    <!-- SECCION: BATERIA Y TEMPERATURA               -->
                    <!-- ============================================ -->
                    <div class="section-title text-warning"><i class="bi bi-battery-charging"></i>BATERIA & TEMPERATURA</div>
                    <div class="row g-2 mb-3">
                        <div class="col-md-3">
                            <div class="device-card text-center p-2">
                                <div class="metric-label"><i class="bi bi-battery-full me-1"></i>CAPACIDAD</div>
                                <div class="metric-value"><span id="val_bat">--</span> <span class="metric-unit">%</span></div>
                                <div class="progress mt-1" style="height: 4px; background: rgba(255,255,255,0.1);">
                                    <div id="prog_bat" class="progress-bar bg-success" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="device-card text-center p-2">
                                <div class="metric-label"><i class="bi bi-lightning-charge me-1"></i>VOLTAJE BAT</div>
                                <div class="metric-value"><span id="val_vbat">--</span> <span class="metric-unit">V</span></div>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="device-card text-center p-2">
                                <div class="metric-label"><i class="bi bi-arrow-down-up me-1"></i>CORRIENTE BAT</div>
                                <div class="metric-value"><span id="val_ibat">--</span> <span class="metric-unit">A</span></div>
                            </div>
                        </div>
                        <div class="col-md-5">
                            <div class="device-card p-2">
                                <div class="metric-label mb-1"><i class="bi bi-thermometer-half me-1"></i>TEMPERATURA INTERNA</div>
                                <div class="d-flex align-items-center gap-2">
                                    <div class="metric-value"><span id="val_temp">--</span> <span class="metric-unit">&deg;C</span></div>
                                    <div class="temp-bar flex-grow-1">
                                        <div id="temp_bar_fill" class="temp-bar-fill" style="width: 0%; background: #2ecc71;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ============================================ -->
                    <!-- GRAFICAS                                     -->
                    <!-- ============================================ -->
                    <div class="row g-3 mb-3">
                        <!-- Grafica: Voltaje de Entrada por Fase -->
                        <div class="col-md-6">
                            <div class="device-card h-100">
                                <h6 class="text-muted mb-2"><i class="bi bi-graph-up me-1"></i>Voltaje Entrada por Fase</h6>
                                <canvas id="chartVoltajeIn"></canvas>
                            </div>
                        </div>
                        <!-- Grafica: Voltaje de Salida por Fase -->
                        <div class="col-md-6">
                            <div class="device-card h-100">
                                <h6 class="text-muted mb-2"><i class="bi bi-graph-up me-1"></i>Voltaje Salida por Fase</h6>
                                <canvas id="chartVoltajeOut"></canvas>
                            </div>
                        </div>
                    </div>

                    <div class="row g-3">
                        <!-- Grafica: Estado de Bateria (Doughnut) -->
                        <div class="col-md-4">
                            <div class="device-card h-100 text-center">
                                <h6 class="text-muted mb-2"><i class="bi bi-battery-charging me-1"></i>Estado de Bateria</h6>
                                <canvas id="chartBateria"></canvas>
                                <div class="mt-2">
                                    <span class="metric-mini" id="bat_center_label">--%</span>
                                </div>
                            </div>
                        </div>
                        <!-- Grafica: Frecuencia Entrada vs Salida -->
                        <div class="col-md-4">
                            <div class="device-card h-100">
                                <h6 class="text-muted mb-2"><i class="bi bi-soundwave me-1"></i>Frecuencia (Hz)</h6>
                                <canvas id="chartFrequency"></canvas>
                            </div>
                        </div>
                        <!-- Grafica: Temperatura -->
                        <div class="col-md-4">
                            <div class="device-card h-100">
                                <h6 class="text-muted mb-2"><i class="bi bi-thermometer-half me-1"></i>Temperatura Interna</h6>
                                <canvas id="chartTemp"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Agregar Dispositivo -->
    <div class="modal fade" id="addDeviceModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content"
                style="background: rgba(30,30,30,0.95); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 0 50px rgba(0,0,0,0.5);">
                <div class="modal-header border-bottom border-dark">
                    <h5 class="modal-title font-monospace fw-bold text-white"><i
                            class="bi bi-hdd-network me-2 text-danger"></i>AGREGAR DISPOSITIVO</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <form id="addDeviceForm">
                        <div class="mb-4">
                            <label class="form-label text-white-50 small text-uppercase fw-bold">Identificacion del
                                Equipo</label>
                            <div class="input-group">
                                <span class="input-group-text bg-dark border-secondary text-secondary"><i
                                        class="bi bi-tag-fill"></i></span>
                                <input type="text" class="form-control bg-dark text-white border-secondary" id="devName"
                                    placeholder="Ej: UPS Servidor Central" required>
                            </div>
                            <div class="form-text text-white-50 small">Un nombre descriptivo para identificar este UPS
                                en el dashboard.</div>
                        </div>

                        <div class="mb-2">
                            <label class="form-label text-white-50 small text-uppercase fw-bold">Parametros de Conexion
                                (Modbus TCP)</label>
                        </div>

                        <div class="row g-3">
                            <div class="col-md-12">
                                <div class="input-group">
                                    <span class="input-group-text bg-dark border-secondary text-secondary"><i
                                            class="bi bi-globe"></i></span>
                                    <input type="text" class="form-control bg-dark text-white border-secondary"
                                        id="devIp" placeholder="192.168.x.x o 10.147.x.x" required>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label text-white-50 small">Puerto TCP</label>
                                <div class="input-group">
                                    <span class="input-group-text bg-dark border-secondary text-secondary"><i
                                            class="bi bi-door-open"></i></span>
                                    <input type="number" class="form-control bg-dark text-white border-secondary"
                                        id="devPort" value="502">
                                </div>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label text-white-50 small">Modbus Slave ID</label>
                                <div class="input-group">
                                    <span class="input-group-text bg-dark border-secondary text-secondary"><i
                                            class="bi bi-person-badge"></i></span>
                                    <input type="number" class="form-control bg-dark text-white border-secondary"
                                        id="devSlave" value="1">
                                </div>
                            </div>
                        </div>

                        <div class="alert alert-dark border-secondary mt-4 d-flex align-items-center" role="alert">
                            <i class="bi bi-info-circle-fill text-info me-3 fs-4"></i>
                            <div class="small text-muted">
                                Asegurate de que el dispositivo este accesible en la red ZeroTier o Local antes de
                                guardar.
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer border-top border-dark p-3">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-danger px-4 fw-bold" onclick="addDevice()">
                        <i class="bi bi-plus-lg me-2"></i>GUARDAR DISPOSITIVO
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const socket = io();
        let devices = {};
        let currentDevId = null;

        // Charts
        let chartVIn = null;   // Voltaje Entrada por fase
        let chartVOut = null;  // Voltaje Salida por fase
        let chartB = null;     // Bateria doughnut
        let chartFreq = null;  // Frecuencia
        let chartTemp = null;  // Temperatura

        // Colores por fase
        const PHASE_COLORS = {
            l1: '#e74c3c',  // Rojo
            l2: '#f39c12',  // Naranja/Amarillo
            l3: '#3498db'   // Azul
        };

        // Configuracion comun para charts de linea
        function lineChartConfig(datasets) {
            return {
                type: 'line',
                data: { labels: [], datasets: datasets },
                options: {
                    responsive: true,
                    animation: false,
                    interaction: { intersect: false, mode: 'index' },
                    scales: {
                        y: {
                            beginAtZero: false,
                            grid: { color: 'rgba(255,255,255,0.07)' },
                            ticks: { color: 'rgba(255,255,255,0.5)', font: { size: 10 } }
                        },
                        x: {
                            display: false
                        }
                    },
                    plugins: {
                        legend: {
                            labels: { color: '#fff', usePointStyle: true, pointStyle: 'circle', padding: 15, font: { size: 11 } }
                        }
                    }
                }
            };
        }

        function initCharts() {
            // --- Voltaje Entrada por Fase ---
            chartVIn = new Chart(document.getElementById('chartVoltajeIn').getContext('2d'), lineChartConfig([
                { label: 'L1', borderColor: PHASE_COLORS.l1, backgroundColor: 'rgba(231,76,60,0.1)', data: [], tension: 0.4, borderWidth: 2, pointRadius: 0, fill: false },
                { label: 'L2', borderColor: PHASE_COLORS.l2, backgroundColor: 'rgba(243,156,18,0.1)', data: [], tension: 0.4, borderWidth: 2, pointRadius: 0, fill: false },
                { label: 'L3', borderColor: PHASE_COLORS.l3, backgroundColor: 'rgba(52,152,219,0.1)', data: [], tension: 0.4, borderWidth: 2, pointRadius: 0, fill: false }
            ]));

            // --- Voltaje Salida por Fase ---
            chartVOut = new Chart(document.getElementById('chartVoltajeOut').getContext('2d'), lineChartConfig([
                { label: 'L1', borderColor: PHASE_COLORS.l1, backgroundColor: 'rgba(231,76,60,0.1)', data: [], tension: 0.4, borderWidth: 2, pointRadius: 0, fill: false },
                { label: 'L2', borderColor: PHASE_COLORS.l2, backgroundColor: 'rgba(243,156,18,0.1)', data: [], tension: 0.4, borderWidth: 2, pointRadius: 0, fill: false },
                { label: 'L3', borderColor: PHASE_COLORS.l3, backgroundColor: 'rgba(52,152,219,0.1)', data: [], tension: 0.4, borderWidth: 2, pointRadius: 0, fill: false }
            ]));

            // --- Bateria Doughnut ---
            chartB = new Chart(document.getElementById('chartBateria').getContext('2d'), {
                type: 'doughnut',
                data: {
                    labels: ['Carga', 'Disponible'],
                    datasets: [{
                        data: [0, 100],
                        backgroundColor: ['#2ecc71', 'rgba(255,255,255,0.05)'],
                        borderWidth: 0
                    }]
                },
                options: {
                    cutout: '75%',
                    plugins: { legend: { display: false } },
                    animation: { duration: 500 }
                }
            });

            // --- Frecuencia ---
            chartFreq = new Chart(document.getElementById('chartFrequency').getContext('2d'), lineChartConfig([
                { label: 'Entrada', borderColor: '#9b59b6', data: [], tension: 0.4, borderWidth: 2, pointRadius: 0, borderDash: [5, 3] },
                { label: 'Salida', borderColor: '#1abc9c', data: [], tension: 0.4, borderWidth: 2, pointRadius: 0 }
            ]));

            // --- Temperatura ---
            chartTemp = new Chart(document.getElementById('chartTemp').getContext('2d'), lineChartConfig([
                { label: 'Temp (C)', borderColor: '#e67e22', backgroundColor: 'rgba(230,126,34,0.15)', data: [], tension: 0.4, borderWidth: 2, pointRadius: 0, fill: true }
            ]));
        }

        // Utilidad para agregar punto a un chart y mantener max 30 puntos
        function pushChartData(chart, label, values) {
            const maxPoints = 30;
            if (chart.data.labels.length >= maxPoints) {
                chart.data.labels.shift();
                chart.data.datasets.forEach(ds => ds.data.shift());
            }
            chart.data.labels.push(label);
            values.forEach((v, i) => {
                if (chart.data.datasets[i]) chart.data.datasets[i].data.push(v);
            });
            chart.update('none');
        }

        // Load devices list
        fetch('/api/monitoreo/list')
            .then(r => r.json())
            .then(data => {
                const container = document.getElementById('deviceList');
                container.innerHTML = '';
                data.forEach(dev => {
                    devices[dev.id] = dev;
                    renderDeviceCard(dev);
                });
            });

        function renderDeviceCard(dev) {
            const container = document.getElementById('deviceList');
            let card = document.getElementById(`card-${dev.id}`);
            if (!card) {
                card = document.createElement('div');
                card.id = `card-${dev.id}`;
                card.className = 'device-card cursor-pointer';
                card.onclick = () => selectDevice(dev.id);
                container.appendChild(card);
            }

            const statusClass = dev.status === 'online' ? 'status-online' : 'status-offline';

            card.innerHTML = `
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="fw-bold text-white mb-1" style="font-size:0.85rem;">${dev.nombre || dev.name}</div>
                        <div class="small text-muted">${dev.ip}</div>
                    </div>
                    <div>
                        <span class="status-dot ${statusClass}" id="status-${dev.id}"></span>
                        <button class="btn btn-sm btn-link text-danger p-0" onclick="deleteDevice(${dev.id}, event)"><i class="bi bi-trash"></i></button>
                    </div>
                </div>
            `;
        }

        function addDevice() {
            const data = {
                nombre: document.getElementById('devName').value,
                ip: document.getElementById('devIp').value,
                port: document.getElementById('devPort').value,
                slave_id: document.getElementById('devSlave').value
            };

            fetch('/api/monitoreo/add', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            }).then(r => {
                if (r.ok) location.reload();
                else alert('Error al agregar');
            });
        }

        function deleteDevice(id, e) {
            e.stopPropagation();
            if (confirm('Eliminar dispositivo?')) {
                fetch(`/api/monitoreo/delete/${id}`, { method: 'DELETE' })
                    .then(r => {
                        const card = document.getElementById(`card-${id}`);
                        if (card) card.remove();
                    });
            }
        }

        function selectDevice(id) {
            currentDevId = id;
            document.getElementById('dashboardView').style.display = 'none';
            document.getElementById('monitorPanel').style.display = 'block';

            const dev = devices[id];
            if (dev) {
                document.getElementById('currentDevName').textContent = dev.nombre || dev.name;
                document.getElementById('currentDevIp').textContent = dev.ip;
                // Limpiar todas las graficas
                [chartVIn, chartVOut, chartFreq, chartTemp].forEach(c => {
                    if (c) {
                        c.data.labels = [];
                        c.data.datasets.forEach(ds => ds.data = []);
                        c.update();
                    }
                });
            }
        }

        // Funcion para color de temperatura
        function getTempColor(temp) {
            if (temp <= 25) return '#2ecc71';       // Verde
            if (temp <= 35) return '#f39c12';       // Naranja
            if (temp <= 45) return '#e67e22';       // Naranja oscuro
            return '#e74c3c';                        // Rojo
        }

        // Socket IO Events
        socket.on('ups_update', (data) => {
            // Update device list status dot
            const cardStatus = document.getElementById(`status-${data.id}`);
            if (cardStatus) {
                cardStatus.className = `status-dot ${data.status === 'online' ? 'status-online' : 'status-offline'}`;
            }

            // Cache data
            devices[data.id] = { ...devices[data.id], ...data };

            // Update details if this device is selected
            if (currentDevId === data.id && data.data) {
                const d = data.data;

                // Status badge
                document.getElementById('currentDevStatus').textContent = data.status.toUpperCase();
                document.getElementById('currentDevStatus').className = `badge bg-${data.status === 'online' ? 'success' : 'danger'}`;

                // --- ENTRADA ---
                document.getElementById('val_vin_l1').textContent = d.voltaje_in_l1 || '--';
                document.getElementById('val_vin_l2').textContent = d.voltaje_in_l2 || '--';
                document.getElementById('val_vin_l3').textContent = d.voltaje_in_l3 || '--';
                document.getElementById('val_freq_in').textContent = d.frecuencia_in || '--';
                document.getElementById('val_load').textContent = d.carga_pct || '--';

                const lPct = d.carga_pct || 0;
                document.getElementById('prog_load').style.width = `${lPct}%`;
                // Cambiar color de carga segun nivel
                const progLoad = document.getElementById('prog_load');
                if (lPct > 90) progLoad.className = 'progress-bar bg-danger';
                else if (lPct > 70) progLoad.className = 'progress-bar bg-warning';
                else progLoad.className = 'progress-bar bg-info';

                // --- SALIDA ---
                document.getElementById('val_vout_l1').textContent = d.voltaje_out_l1 || '--';
                document.getElementById('val_vout_l2').textContent = d.voltaje_out_l2 || '--';
                document.getElementById('val_vout_l3').textContent = d.voltaje_out_l3 || '--';
                document.getElementById('val_freq_out').textContent = d.frecuencia_out || '--';
                document.getElementById('val_iout').textContent = d.corriente_out || '--';

                // --- BATERIA & TEMPERATURA ---
                const bPct = d.bateria_pct || 0;
                document.getElementById('val_bat').textContent = bPct;
                document.getElementById('prog_bat').style.width = `${bPct}%`;
                // Color de bateria segun nivel
                const progBat = document.getElementById('prog_bat');
                if (bPct < 20) progBat.className = 'progress-bar bg-danger';
                else if (bPct < 50) progBat.className = 'progress-bar bg-warning';
                else progBat.className = 'progress-bar bg-success';

                document.getElementById('val_vbat').textContent = d.voltaje_bateria || '--';
                document.getElementById('val_ibat').textContent = d.corriente_bateria || '--';

                const temp = d.temperatura || 0;
                document.getElementById('val_temp').textContent = temp;
                // Barra de temperatura (rango 0-60C)
                const tempPct = Math.min((temp / 60) * 100, 100);
                const tempFill = document.getElementById('temp_bar_fill');
                tempFill.style.width = `${tempPct}%`;
                tempFill.style.backgroundColor = getTempColor(temp);

                // --- UPDATE CHARTS ---
                const now = new Date().toLocaleTimeString();

                // Voltaje Entrada por fase
                if (chartVIn) {
                    pushChartData(chartVIn, now, [d.voltaje_in_l1, d.voltaje_in_l2, d.voltaje_in_l3]);
                }

                // Voltaje Salida por fase
                if (chartVOut) {
                    pushChartData(chartVOut, now, [d.voltaje_out_l1, d.voltaje_out_l2, d.voltaje_out_l3]);
                }

                // Bateria doughnut
                if (chartB) {
                    chartB.data.datasets[0].data = [bPct, 100 - bPct];
                    // Color segun nivel
                    if (bPct < 20) chartB.data.datasets[0].backgroundColor[0] = '#e74c3c';
                    else if (bPct < 50) chartB.data.datasets[0].backgroundColor[0] = '#f39c12';
                    else chartB.data.datasets[0].backgroundColor[0] = '#2ecc71';
                    chartB.update();
                    document.getElementById('bat_center_label').textContent = `${bPct}%`;
                }

                // Frecuencia
                if (chartFreq) {
                    pushChartData(chartFreq, now, [d.frecuencia_in, d.frecuencia_out]);
                }

                // Temperatura
                if (chartTemp) {
                    pushChartData(chartTemp, now, [temp]);
                }
            }
        });

        // Init
        initCharts();
    </script>
</body>

</html>
