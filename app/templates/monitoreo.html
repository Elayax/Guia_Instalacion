<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitoreo - Sistema UPS Manager</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .device-card {
            background: rgba(30, 30, 30, 0.6);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
        }

        .device-card:hover {
            border-color: var(--accent-red);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .status-dot {
            height: 12px;
            width: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }

        .status-online {
            background-color: #2ecc71;
            box-shadow: 0 0 10px #2ecc71;
        }

        .status-offline {
            background-color: #e74c3c;
            box-shadow: 0 0 5px #e74c3c;
        }

        .metric-value {
            font-size: 1.4rem;
            font-weight: 700;
            color: #fff;
        }

        .metric-label {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.6);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .metric-unit {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.5);
            font-weight: 400;
        }

        .section-title {
            font-size: 0.85rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            padding-bottom: 0.5rem;
            margin-bottom: 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .section-title i {
            margin-right: 0.5rem;
        }

        .phase-badge {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 4px;
        }

        .phase-l1 { background-color: #e74c3c; }
        .phase-l2 { background-color: #f39c12; }
        .phase-l3 { background-color: #3498db; }

        .metric-mini {
            font-size: 1rem;
            font-weight: 600;
            color: #fff;
        }

        .temp-bar {
            height: 6px;
            border-radius: 3px;
            flex: 1;
            background: rgba(255, 255, 255, 0.1);
            overflow: hidden;
        }

        .temp-bar-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.5s ease, background-color 0.5s ease;
        }

        /* Alarm panel */
        .alarm-panel {
            max-height: 200px;
            overflow-y: auto;
        }

        .alarm-item {
            padding: 6px 10px;
            border-radius: 6px;
            margin-bottom: 4px;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .alarm-critical {
            background: rgba(231, 76, 60, 0.15);
            border-left: 3px solid #e74c3c;
            color: #e74c3c;
        }

        .alarm-warning {
            background: rgba(243, 156, 18, 0.15);
            border-left: 3px solid #f39c12;
            color: #f39c12;
        }

        .alarm-info {
            background: rgba(52, 152, 219, 0.15);
            border-left: 3px solid #3498db;
            color: #3498db;
        }

        .status-badge-lg {
            font-size: 0.75rem;
            padding: 4px 10px;
            border-radius: 20px;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        .protocol-badge {
            font-size: 0.65rem;
            padding: 2px 6px;
            border-radius: 4px;
            text-transform: uppercase;
        }

        .sidebar-card {
            padding: 0.8rem;
            margin-bottom: 0.5rem;
            cursor: pointer;
        }

        .sidebar-card.active {
            border-color: var(--accent-red) !important;
            box-shadow: 0 0 15px rgba(231, 76, 60, 0.2);
        }

        /* Module cards */
        .module-card {
            background: rgba(40, 40, 40, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 8px;
            padding: 0.8rem;
        }
    </style>
</head>

<body>
    <header class="app-header">
        <div class="d-flex align-items-center gap-3">
            <img src="{{ url_for('static', filename='logo.png') }}" alt="Logo" height="40">
            <span style="font-weight:700; font-size:1.2rem; letter-spacing:1px; color: #fff;">SISTEMA UPS <span
                    style="color:var(--accent-red)">MANAGER</span></span>
        </div>
        <nav class="nav-links">
            <a href="{{ url_for('dashboard.dashboard') }}" class="nav-link"><i class="bi bi-speedometer2 me-1"></i>
                DASHBOARD</a>
            <a href="{{ url_for('calculator.calculadora') }}" class="nav-link"><i class="bi bi-calculator me-1"></i>
                CALCULADORA</a>
            <a href="{{ url_for('management.gestion') }}" class="nav-link"><i class="bi bi-database me-1"></i> GESTION
                BD</a>
            <a href="{{ url_for('monitoreo.index') }}" class="nav-link active"><i class="bi bi-activity me-1"></i>
                MONITOREO</a>
        </nav>
    </header>

    <div class="container-fluid p-4">
        <div class="row">
            <!-- Sidebar: Lista de Dispositivos -->
            <div class="col-md-2">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="text-white m-0">Dispositivos</h5>
                    <button class="btn btn-sm btn-outline-success" data-bs-toggle="modal"
                        data-bs-target="#addDeviceModal">
                        <i class="bi bi-plus-lg"></i>
                    </button>
                </div>
                <div id="deviceList">
                    <div class="text-center text-muted mt-5">
                        <div class="spinner-border text-secondary" role="status"></div>
                        <p class="mt-2">Cargando...</p>
                    </div>
                </div>
            </div>

            <!-- Main: Detalles y Graficas -->
            <div class="col-md-10">
                <div id="dashboardView" class="text-center text-muted mt-5 fade-in">
                    <i class="bi bi-activity" style="font-size: 4rem; opacity: 0.2;"></i>
                    <h3 class="mt-3">Panel en Tiempo Real</h3>
                    <p>Seleccione un dispositivo o espere datos...</p>
                </div>

                <div id="monitorPanel" style="display:none;">
                    <!-- Header del dispositivo -->
                    <div class="d-flex justify-content-between align-items-end mb-3 border-bottom border-secondary pb-2">
                        <div>
                            <h2 class="text-white mb-0" id="currentDevName">UPS Principal</h2>
                            <small class="text-muted" id="currentDevIp">192.168.1.100</small>
                            <span class="protocol-badge bg-secondary ms-2" id="currentDevProtocol">MODBUS</span>
                        </div>
                        <div class="d-flex gap-2 align-items-center">
                            <div id="currentPowerMode" class="status-badge-lg bg-secondary">--</div>
                            <div id="currentBatStatus" class="status-badge-lg bg-secondary">--</div>
                            <div id="currentDevStatus" class="badge bg-success">ONLINE</div>
                        </div>
                    </div>

                    <!-- ============================================ -->
                    <!-- PANEL DE ALARMAS                             -->
                    <!-- ============================================ -->
                    <div id="alarmContainer" style="display:none;" class="mb-3">
                        <div class="device-card p-2">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <div class="section-title text-danger m-0 border-0 pb-0"><i class="bi bi-exclamation-triangle-fill"></i>ALARMAS ACTIVAS</div>
                                <span class="badge bg-danger" id="alarmCount">0</span>
                            </div>
                            <div id="alarmPanel" class="alarm-panel"></div>
                        </div>
                    </div>

                    <!-- ============================================ -->
                    <!-- SECCION: VOLTAJES DE ENTRADA (por fase)      -->
                    <!-- ============================================ -->
                    <div class="section-title text-info"><i class="bi bi-box-arrow-in-right"></i>ENTRADA</div>
                    <div class="row g-2 mb-3">
                        <div class="col-md-2">
                            <div class="device-card text-center p-2">
                                <div class="metric-label"><span class="phase-badge phase-l1"></span>L1</div>
                                <div class="metric-value"><span id="val_vin_l1">--</span> <span class="metric-unit">V</span></div>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="device-card text-center p-2">
                                <div class="metric-label"><span class="phase-badge phase-l2"></span>L2</div>
                                <div class="metric-value"><span id="val_vin_l2">--</span> <span class="metric-unit">V</span></div>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="device-card text-center p-2">
                                <div class="metric-label"><span class="phase-badge phase-l3"></span>L3</div>
                                <div class="metric-value"><span id="val_vin_l3">--</span> <span class="metric-unit">V</span></div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="device-card text-center p-2">
                                <div class="metric-label"><i class="bi bi-activity me-1"></i>FRECUENCIA ENTRADA</div>
                                <div class="metric-value"><span id="val_freq_in">--</span> <span class="metric-unit">Hz</span></div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="device-card text-center p-2">
                                <div class="metric-label"><i class="bi bi-lightning me-1"></i>CARGA</div>
                                <div class="metric-value"><span id="val_load">--</span> <span class="metric-unit">%</span></div>
                                <div class="progress mt-1" style="height: 4px; background: rgba(255,255,255,0.1);">
                                    <div id="prog_load" class="progress-bar bg-info" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ============================================ -->
                    <!-- SECCION: VOLTAJES DE SALIDA (por fase)       -->
                    <!-- ============================================ -->
                    <div class="section-title text-success"><i class="bi bi-box-arrow-right"></i>SALIDA</div>
                    <div class="row g-2 mb-3">
                        <div class="col-md-2">
                            <div class="device-card text-center p-2">
                                <div class="metric-label"><span class="phase-badge phase-l1"></span>L1</div>
                                <div class="metric-value"><span id="val_vout_l1">--</span> <span class="metric-unit">V</span></div>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="device-card text-center p-2">
                                <div class="metric-label"><span class="phase-badge phase-l2"></span>L2</div>
                                <div class="metric-value"><span id="val_vout_l2">--</span> <span class="metric-unit">V</span></div>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="device-card text-center p-2">
                                <div class="metric-label"><span class="phase-badge phase-l3"></span>L3</div>
                                <div class="metric-value"><span id="val_vout_l3">--</span> <span class="metric-unit">V</span></div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="device-card text-center p-2">
                                <div class="metric-label"><i class="bi bi-activity me-1"></i>FRECUENCIA SALIDA</div>
                                <div class="metric-value"><span id="val_freq_out">--</span> <span class="metric-unit">Hz</span></div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="device-card text-center p-2">
                                <div class="metric-label"><i class="bi bi-clock me-1"></i>AUTONOMIA</div>
                                <div class="metric-value"><span id="val_remain_time">--</span> <span class="metric-unit">min</span></div>
                            </div>
                        </div>
                    </div>

                    <!-- ============================================ -->
                    <!-- SECCION: POTENCIA Y CORRIENTES               -->
                    <!-- ============================================ -->
                    <div class="section-title text-primary"><i class="bi bi-lightning-charge"></i>POTENCIA & CORRIENTE</div>
                    <div class="row g-2 mb-3">
                        <div class="col-md-2">
                            <div class="device-card text-center p-2">
                                <div class="metric-label"><span class="phase-badge phase-l1"></span>I-L1</div>
                                <div class="metric-value"><span id="val_iout_l1">--</span> <span class="metric-unit">A</span></div>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="device-card text-center p-2">
                                <div class="metric-label"><span class="phase-badge phase-l2"></span>I-L2</div>
                                <div class="metric-value"><span id="val_iout_l2">--</span> <span class="metric-unit">A</span></div>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="device-card text-center p-2">
                                <div class="metric-label"><span class="phase-badge phase-l3"></span>I-L3</div>
                                <div class="metric-value"><span id="val_iout_l3">--</span> <span class="metric-unit">A</span></div>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="device-card text-center p-2">
                                <div class="metric-label">FACTOR POT.</div>
                                <div class="metric-value"><span id="val_pf">--</span></div>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="device-card text-center p-2">
                                <div class="metric-label">POT. ACTIVA</div>
                                <div class="metric-value"><span id="val_pwr_active">--</span> <span class="metric-unit">kW</span></div>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="device-card text-center p-2">
                                <div class="metric-label">POT. APARENTE</div>
                                <div class="metric-value"><span id="val_pwr_apparent">--</span> <span class="metric-unit">kVA</span></div>
                            </div>
                        </div>
                    </div>

                    <!-- ============================================ -->
                    <!-- SECCION: BATERIA Y TEMPERATURA               -->
                    <!-- ============================================ -->
                    <div class="section-title text-warning"><i class="bi bi-battery-charging"></i>BATERIA & TEMPERATURA</div>
                    <div class="row g-2 mb-3">
                        <div class="col-md-3">
                            <div class="device-card text-center p-2">
                                <div class="metric-label"><i class="bi bi-battery-full me-1"></i>CAPACIDAD</div>
                                <div class="metric-value"><span id="val_bat">--</span> <span class="metric-unit">%</span></div>
                                <div class="progress mt-1" style="height: 4px; background: rgba(255,255,255,0.1);">
                                    <div id="prog_bat" class="progress-bar bg-success" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="device-card text-center p-2">
                                <div class="metric-label"><i class="bi bi-lightning-charge me-1"></i>VOLTAJE BAT</div>
                                <div class="metric-value"><span id="val_vbat">--</span> <span class="metric-unit">V</span></div>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="device-card text-center p-2">
                                <div class="metric-label"><i class="bi bi-arrow-down-up me-1"></i>CORRIENTE BAT</div>
                                <div class="metric-value"><span id="val_ibat">--</span> <span class="metric-unit">A</span></div>
                            </div>
                        </div>
                        <div class="col-md-5">
                            <div class="device-card p-2">
                                <div class="metric-label mb-1"><i class="bi bi-thermometer-half me-1"></i>TEMPERATURA BATERIA</div>
                                <div class="d-flex align-items-center gap-2">
                                    <div class="metric-value"><span id="val_temp">--</span> <span class="metric-unit">&deg;C</span></div>
                                    <div class="temp-bar flex-grow-1">
                                        <div id="temp_bar_fill" class="temp-bar-fill" style="width: 0%; background: #2ecc71;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ============================================ -->
                    <!-- SECCION: AMBIENTE (THS + WATER)              -->
                    <!-- ============================================ -->
                    <div id="envSection" style="display:none;">
                        <div class="section-title" style="color: #1abc9c;"><i class="bi bi-moisture"></i>AMBIENTE</div>
                        <div class="row g-2 mb-3">
                            <div class="col-md-3">
                                <div class="device-card text-center p-2">
                                    <div class="metric-label"><i class="bi bi-thermometer me-1"></i>TEMP. AMBIENTE</div>
                                    <div class="metric-value"><span id="val_env_temp">--</span> <span class="metric-unit">&deg;C</span></div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="device-card text-center p-2">
                                    <div class="metric-label"><i class="bi bi-droplet me-1"></i>HUMEDAD</div>
                                    <div class="metric-value"><span id="val_env_hum">--</span> <span class="metric-unit">%</span></div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="device-card text-center p-2">
                                    <div class="metric-label"><i class="bi bi-water me-1"></i>FUGA DE AGUA</div>
                                    <div class="metric-value"><span id="val_water_leak">Sin fuga</span></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ============================================ -->
                    <!-- SECCION: MODULOS (UPS Modular)               -->
                    <!-- ============================================ -->
                    <div id="modulesSection" style="display:none;">
                        <div class="section-title" style="color: #9b59b6;"><i class="bi bi-grid-3x3-gap"></i>MODULOS</div>
                        <div class="row g-2 mb-3" id="modulesContainer"></div>
                    </div>

                    <!-- ============================================ -->
                    <!-- GRAFICAS                                     -->
                    <!-- ============================================ -->
                    <div class="row g-3 mb-3">
                        <div class="col-md-6">
                            <div class="device-card h-100">
                                <h6 class="text-muted mb-2"><i class="bi bi-graph-up me-1"></i>Voltaje Entrada por Fase</h6>
                                <canvas id="chartVoltajeIn"></canvas>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="device-card h-100">
                                <h6 class="text-muted mb-2"><i class="bi bi-graph-up me-1"></i>Voltaje Salida por Fase</h6>
                                <canvas id="chartVoltajeOut"></canvas>
                            </div>
                        </div>
                    </div>

                    <div class="row g-3">
                        <div class="col-md-4">
                            <div class="device-card h-100 text-center">
                                <h6 class="text-muted mb-2"><i class="bi bi-battery-charging me-1"></i>Estado de Bateria</h6>
                                <canvas id="chartBateria"></canvas>
                                <div class="mt-2">
                                    <span class="metric-mini" id="bat_center_label">--%</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="device-card h-100">
                                <h6 class="text-muted mb-2"><i class="bi bi-soundwave me-1"></i>Frecuencia (Hz)</h6>
                                <canvas id="chartFrequency"></canvas>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="device-card h-100">
                                <h6 class="text-muted mb-2"><i class="bi bi-thermometer-half me-1"></i>Temperatura</h6>
                                <canvas id="chartTemp"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Agregar Dispositivo -->
    <div class="modal fade" id="addDeviceModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content"
                style="background: rgba(30,30,30,0.95); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 0 50px rgba(0,0,0,0.5);">
                <div class="modal-header border-bottom border-dark">
                    <h5 class="modal-title font-monospace fw-bold text-white"><i
                            class="bi bi-hdd-network me-2 text-danger"></i>AGREGAR DISPOSITIVO</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <form id="addDeviceForm">
                        <div class="mb-4">
                            <label class="form-label text-white-50 small text-uppercase fw-bold">Identificacion del Equipo</label>
                            <div class="input-group">
                                <span class="input-group-text bg-dark border-secondary text-secondary"><i class="bi bi-tag-fill"></i></span>
                                <input type="text" class="form-control bg-dark text-white border-secondary" id="devName"
                                    placeholder="Ej: UPS Servidor Central" required>
                            </div>
                        </div>

                        <!-- Selector de Protocolo -->
                        <div class="mb-4">
                            <label class="form-label text-white-50 small text-uppercase fw-bold">Protocolo de Comunicacion</label>
                            <div class="btn-group w-100" role="group">
                                <input type="radio" class="btn-check" name="protocolo" id="proto_modbus" value="modbus" checked>
                                <label class="btn btn-outline-info" for="proto_modbus"><i class="bi bi-cpu me-1"></i>Modbus TCP</label>
                                <input type="radio" class="btn-check" name="protocolo" id="proto_snmp" value="snmp">
                                <label class="btn btn-outline-info" for="proto_snmp"><i class="bi bi-router me-1"></i>SNMP</label>
                            </div>
                        </div>

                        <div class="mb-2">
                            <label class="form-label text-white-50 small text-uppercase fw-bold">Parametros de Conexion</label>
                        </div>

                        <div class="row g-3">
                            <div class="col-md-12">
                                <div class="input-group">
                                    <span class="input-group-text bg-dark border-secondary text-secondary"><i class="bi bi-globe"></i></span>
                                    <input type="text" class="form-control bg-dark text-white border-secondary"
                                        id="devIp" placeholder="192.168.x.x o 10.147.x.x" required>
                                </div>
                            </div>

                            <!-- Modbus fields -->
                            <div id="modbusFields">
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label class="form-label text-white-50 small">Puerto TCP</label>
                                        <div class="input-group">
                                            <span class="input-group-text bg-dark border-secondary text-secondary"><i class="bi bi-door-open"></i></span>
                                            <input type="number" class="form-control bg-dark text-white border-secondary" id="devPort" value="502">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label text-white-50 small">Modbus Slave ID</label>
                                        <div class="input-group">
                                            <span class="input-group-text bg-dark border-secondary text-secondary"><i class="bi bi-person-badge"></i></span>
                                            <input type="number" class="form-control bg-dark text-white border-secondary" id="devSlave" value="1">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- SNMP fields -->
                            <div id="snmpFields" style="display:none;">
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label class="form-label text-white-50 small">Puerto SNMP</label>
                                        <div class="input-group">
                                            <span class="input-group-text bg-dark border-secondary text-secondary"><i class="bi bi-door-open"></i></span>
                                            <input type="number" class="form-control bg-dark text-white border-secondary" id="devSnmpPort" value="161">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label text-white-50 small">Community String</label>
                                        <div class="input-group">
                                            <span class="input-group-text bg-dark border-secondary text-secondary"><i class="bi bi-key"></i></span>
                                            <input type="text" class="form-control bg-dark text-white border-secondary" id="devCommunity" value="public">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="alert alert-dark border-secondary mt-4 d-flex align-items-center" role="alert">
                            <i class="bi bi-info-circle-fill text-info me-3 fs-4"></i>
                            <div class="small text-muted">
                                Asegurate de que el dispositivo este accesible en la red ZeroTier o Local antes de guardar.
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer border-top border-dark p-3">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-danger px-4 fw-bold" onclick="addDevice()">
                        <i class="bi bi-plus-lg me-2"></i>GUARDAR DISPOSITIVO
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const socket = io();
        let devices = {};
        let currentDevId = null;

        // Charts
        let chartVIn = null;
        let chartVOut = null;
        let chartB = null;
        let chartFreq = null;
        let chartTemp = null;

        const PHASE_COLORS = {
            l1: '#e74c3c',
            l2: '#f39c12',
            l3: '#3498db'
        };

        // Toggle protocol fields in modal
        document.querySelectorAll('input[name="protocolo"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                const isModbus = e.target.value === 'modbus';
                document.getElementById('modbusFields').style.display = isModbus ? 'block' : 'none';
                document.getElementById('snmpFields').style.display = isModbus ? 'none' : 'block';
            });
        });

        function lineChartConfig(datasets) {
            return {
                type: 'line',
                data: { labels: [], datasets: datasets },
                options: {
                    responsive: true,
                    animation: false,
                    interaction: { intersect: false, mode: 'index' },
                    scales: {
                        y: {
                            beginAtZero: false,
                            grid: { color: 'rgba(255,255,255,0.07)' },
                            ticks: { color: 'rgba(255,255,255,0.5)', font: { size: 10 } }
                        },
                        x: { display: false }
                    },
                    plugins: {
                        legend: {
                            labels: { color: '#fff', usePointStyle: true, pointStyle: 'circle', padding: 15, font: { size: 11 } }
                        }
                    }
                }
            };
        }

        function initCharts() {
            chartVIn = new Chart(document.getElementById('chartVoltajeIn').getContext('2d'), lineChartConfig([
                { label: 'L1', borderColor: PHASE_COLORS.l1, data: [], tension: 0.4, borderWidth: 2, pointRadius: 0, fill: false },
                { label: 'L2', borderColor: PHASE_COLORS.l2, data: [], tension: 0.4, borderWidth: 2, pointRadius: 0, fill: false },
                { label: 'L3', borderColor: PHASE_COLORS.l3, data: [], tension: 0.4, borderWidth: 2, pointRadius: 0, fill: false }
            ]));

            chartVOut = new Chart(document.getElementById('chartVoltajeOut').getContext('2d'), lineChartConfig([
                { label: 'L1', borderColor: PHASE_COLORS.l1, data: [], tension: 0.4, borderWidth: 2, pointRadius: 0, fill: false },
                { label: 'L2', borderColor: PHASE_COLORS.l2, data: [], tension: 0.4, borderWidth: 2, pointRadius: 0, fill: false },
                { label: 'L3', borderColor: PHASE_COLORS.l3, data: [], tension: 0.4, borderWidth: 2, pointRadius: 0, fill: false }
            ]));

            chartB = new Chart(document.getElementById('chartBateria').getContext('2d'), {
                type: 'doughnut',
                data: {
                    labels: ['Carga', 'Disponible'],
                    datasets: [{ data: [0, 100], backgroundColor: ['#2ecc71', 'rgba(255,255,255,0.05)'], borderWidth: 0 }]
                },
                options: { cutout: '75%', plugins: { legend: { display: false } }, animation: { duration: 500 } }
            });

            chartFreq = new Chart(document.getElementById('chartFrequency').getContext('2d'), lineChartConfig([
                { label: 'Entrada', borderColor: '#9b59b6', data: [], tension: 0.4, borderWidth: 2, pointRadius: 0, borderDash: [5, 3] },
                { label: 'Salida', borderColor: '#1abc9c', data: [], tension: 0.4, borderWidth: 2, pointRadius: 0 }
            ]));

            chartTemp = new Chart(document.getElementById('chartTemp').getContext('2d'), lineChartConfig([
                { label: 'Bateria', borderColor: '#e67e22', backgroundColor: 'rgba(230,126,34,0.15)', data: [], tension: 0.4, borderWidth: 2, pointRadius: 0, fill: true },
                { label: 'Ambiente', borderColor: '#1abc9c', backgroundColor: 'rgba(26,188,156,0.1)', data: [], tension: 0.4, borderWidth: 2, pointRadius: 0, fill: true, borderDash: [4, 2] }
            ]));
        }

        function pushChartData(chart, label, values) {
            const maxPoints = 60;
            if (chart.data.labels.length >= maxPoints) {
                chart.data.labels.shift();
                chart.data.datasets.forEach(ds => ds.data.shift());
            }
            chart.data.labels.push(label);
            values.forEach((v, i) => {
                if (chart.data.datasets[i]) chart.data.datasets[i].data.push(v);
            });
            chart.update('none');
        }

        // Load devices list
        fetch('/api/monitoreo/list')
            .then(r => r.json())
            .then(data => {
                const container = document.getElementById('deviceList');
                container.innerHTML = '';
                data.forEach(dev => {
                    devices[dev.id] = dev;
                    renderDeviceCard(dev);
                });
            });

        function renderDeviceCard(dev) {
            const container = document.getElementById('deviceList');
            let card = document.getElementById(`card-${dev.id}`);
            if (!card) {
                card = document.createElement('div');
                card.id = `card-${dev.id}`;
                card.className = 'device-card sidebar-card cursor-pointer';
                card.onclick = () => selectDevice(dev.id);
                container.appendChild(card);
            }

            const statusClass = dev.status === 'online' ? 'status-online' : 'status-offline';
            const proto = dev.protocolo || 'modbus';
            const protoBadge = proto === 'snmp'
                ? '<span class="protocol-badge bg-info">SNMP</span>'
                : '<span class="protocol-badge bg-secondary">MODBUS</span>';

            card.innerHTML = `
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="fw-bold text-white mb-1" style="font-size:0.85rem;">${dev.nombre || dev.name}</div>
                        <div class="small text-muted">${dev.ip} ${protoBadge}</div>
                    </div>
                    <div>
                        <span class="status-dot ${statusClass}" id="status-${dev.id}"></span>
                        <button class="btn btn-sm btn-link text-danger p-0" onclick="deleteDevice(${dev.id}, event)"><i class="bi bi-trash"></i></button>
                    </div>
                </div>
            `;

            // Active state
            if (currentDevId === dev.id) {
                card.classList.add('active');
            }
        }

        function addDevice() {
            const protocolo = document.querySelector('input[name="protocolo"]:checked').value;
            const data = {
                nombre: document.getElementById('devName').value,
                ip: document.getElementById('devIp').value,
                protocolo: protocolo,
                port: protocolo === 'modbus' ? document.getElementById('devPort').value : 161,
                slave_id: protocolo === 'modbus' ? document.getElementById('devSlave').value : 1,
                snmp_port: protocolo === 'snmp' ? document.getElementById('devSnmpPort').value : 161,
                snmp_community: protocolo === 'snmp' ? document.getElementById('devCommunity').value : 'public',
            };

            fetch('/api/monitoreo/add', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            }).then(r => {
                if (r.ok) location.reload();
                else alert('Error al agregar');
            });
        }

        function deleteDevice(id, e) {
            e.stopPropagation();
            if (confirm('Eliminar dispositivo?')) {
                fetch(`/api/monitoreo/delete/${id}`, { method: 'DELETE' })
                    .then(r => {
                        const card = document.getElementById(`card-${id}`);
                        if (card) card.remove();
                        if (currentDevId === id) {
                            currentDevId = null;
                            document.getElementById('monitorPanel').style.display = 'none';
                            document.getElementById('dashboardView').style.display = 'block';
                        }
                    });
            }
        }

        function selectDevice(id) {
            currentDevId = id;
            document.getElementById('dashboardView').style.display = 'none';
            document.getElementById('monitorPanel').style.display = 'block';

            // Active state on sidebar
            document.querySelectorAll('.sidebar-card').forEach(c => c.classList.remove('active'));
            const activeCard = document.getElementById(`card-${id}`);
            if (activeCard) activeCard.classList.add('active');

            const dev = devices[id];
            if (dev) {
                document.getElementById('currentDevName').textContent = dev.nombre || dev.name;
                document.getElementById('currentDevIp').textContent = dev.ip;
                document.getElementById('currentDevProtocol').textContent = (dev.protocolo || 'modbus').toUpperCase();

                // Clear charts
                [chartVIn, chartVOut, chartFreq, chartTemp].forEach(c => {
                    if (c) {
                        c.data.labels = [];
                        c.data.datasets.forEach(ds => ds.data = []);
                        c.update();
                    }
                });
            }
        }

        function getTempColor(temp) {
            if (temp <= 25) return '#2ecc71';
            if (temp <= 35) return '#f39c12';
            if (temp <= 45) return '#e67e22';
            return '#e74c3c';
        }

        function renderAlarms(alarms) {
            const container = document.getElementById('alarmContainer');
            const panel = document.getElementById('alarmPanel');
            const count = document.getElementById('alarmCount');

            if (!alarms || alarms.length === 0) {
                container.style.display = 'none';
                return;
            }

            container.style.display = 'block';
            count.textContent = alarms.length;
            panel.innerHTML = '';

            alarms.forEach(a => {
                const iconMap = {
                    critical: 'bi-exclamation-octagon-fill',
                    warning: 'bi-exclamation-triangle-fill',
                    info: 'bi-info-circle-fill'
                };
                panel.innerHTML += `
                    <div class="alarm-item alarm-${a.level}">
                        <i class="bi ${iconMap[a.level] || iconMap.info}"></i>
                        <span>${a.msg}</span>
                    </div>
                `;
            });
        }

        function renderModules(modules) {
            const section = document.getElementById('modulesSection');
            const container = document.getElementById('modulesContainer');

            if (!modules || modules.length === 0) {
                section.style.display = 'none';
                return;
            }

            section.style.display = 'block';
            container.innerHTML = '';

            modules.forEach(m => {
                container.innerHTML += `
                    <div class="col-md-3">
                        <div class="module-card">
                            <div class="fw-bold text-white mb-2" style="font-size:0.85rem;">
                                <i class="bi bi-cpu me-1" style="color:#9b59b6"></i>Modulo ${m.module_number}
                            </div>
                            <div class="row g-1">
                                <div class="col-6"><span class="metric-label">V.In</span><br><span class="metric-mini">${(m.mod_input_voltage_a || 0).toFixed(1)}V</span></div>
                                <div class="col-6"><span class="metric-label">V.Out</span><br><span class="metric-mini">${(m.mod_output_voltage_a || 0).toFixed(1)}V</span></div>
                                <div class="col-6"><span class="metric-label">T.In</span><br><span class="metric-mini">${(m.mod_inlet_temp || 0).toFixed(1)}&deg;</span></div>
                                <div class="col-6"><span class="metric-label">T.Out</span><br><span class="metric-mini">${(m.mod_outlet_temp || 0).toFixed(1)}&deg;</span></div>
                                <div class="col-6"><span class="metric-label">DC Bus</span><br><span class="metric-mini">${(m.mod_dc_bus_voltage || 0).toFixed(1)}V</span></div>
                                <div class="col-6"><span class="metric-label">I.Bat</span><br><span class="metric-mini">${(m.mod_discharge_current || 0).toFixed(1)}A</span></div>
                            </div>
                        </div>
                    </div>
                `;
            });
        }

        // Socket IO Events
        socket.on('ups_update', (data) => {
            // Update device list status dot
            const cardStatus = document.getElementById(`status-${data.id}`);
            if (cardStatus) {
                cardStatus.className = `status-dot ${data.status === 'online' ? 'status-online' : 'status-offline'}`;
            }

            // Cache data
            devices[data.id] = { ...devices[data.id], ...data };

            // Update details if this device is selected
            if (currentDevId === data.id && data.data) {
                const d = data.data;

                // Status badge
                document.getElementById('currentDevStatus').textContent = data.status.toUpperCase();
                document.getElementById('currentDevStatus').className = `badge bg-${data.status === 'online' ? 'success' : 'danger'}`;

                // Power mode & battery status badges
                if (d.power_mode) {
                    const pmEl = document.getElementById('currentPowerMode');
                    pmEl.textContent = d.power_mode;
                    if (d.power_mode.includes('UPS') || d.power_mode.includes('Normal')) pmEl.className = 'status-badge-lg bg-success';
                    else if (d.power_mode.includes('Bypass')) pmEl.className = 'status-badge-lg bg-warning';
                    else pmEl.className = 'status-badge-lg bg-secondary';
                }
                if (d.battery_status) {
                    const bsEl = document.getElementById('currentBatStatus');
                    bsEl.textContent = d.battery_status;
                    if (d.battery_status.includes('Flotacion') || d.battery_status.includes('Flotante')) bsEl.className = 'status-badge-lg bg-success';
                    else if (d.battery_status.includes('Descargando')) bsEl.className = 'status-badge-lg bg-danger';
                    else if (d.battery_status.includes('Carga')) bsEl.className = 'status-badge-lg bg-info';
                    else bsEl.className = 'status-badge-lg bg-secondary';
                }

                // --- ENTRADA ---
                document.getElementById('val_vin_l1').textContent = d.voltaje_in_l1 || '--';
                document.getElementById('val_vin_l2').textContent = d.voltaje_in_l2 || '--';
                document.getElementById('val_vin_l3').textContent = d.voltaje_in_l3 || '--';
                document.getElementById('val_freq_in').textContent = d.frecuencia_in || '--';
                document.getElementById('val_load').textContent = d.carga_pct || '--';

                const lPct = d.carga_pct || 0;
                document.getElementById('prog_load').style.width = `${lPct}%`;
                const progLoad = document.getElementById('prog_load');
                if (lPct > 90) progLoad.className = 'progress-bar bg-danger';
                else if (lPct > 70) progLoad.className = 'progress-bar bg-warning';
                else progLoad.className = 'progress-bar bg-info';

                // --- SALIDA ---
                document.getElementById('val_vout_l1').textContent = d.voltaje_out_l1 || '--';
                document.getElementById('val_vout_l2').textContent = d.voltaje_out_l2 || '--';
                document.getElementById('val_vout_l3').textContent = d.voltaje_out_l3 || '--';
                document.getElementById('val_freq_out').textContent = d.frecuencia_out || '--';
                document.getElementById('val_remain_time').textContent = d.battery_remain_time || '--';

                // --- POTENCIA & CORRIENTES ---
                const iL1 = d.corriente_out_l1 || 0;
                const iL2 = d.corriente_out_l2 || 0;
                const iL3 = d.corriente_out_l3 || 0;

                document.getElementById('val_iout_l1').textContent = iL1;
                document.getElementById('val_iout_l2').textContent = iL2;
                document.getElementById('val_iout_l3').textContent = iL3;

                document.getElementById('val_pf').textContent = d.power_factor || '--';
                document.getElementById('val_pwr_active').textContent = d.active_power || '--';
                document.getElementById('val_pwr_apparent').textContent = d.apparent_power || '--';

                // --- BATERIA & TEMPERATURA ---
                const bPct = d.bateria_pct || 0;
                document.getElementById('val_bat').textContent = bPct;
                document.getElementById('prog_bat').style.width = `${bPct}%`;
                const progBat = document.getElementById('prog_bat');
                if (bPct < 20) progBat.className = 'progress-bar bg-danger';
                else if (bPct < 50) progBat.className = 'progress-bar bg-warning';
                else progBat.className = 'progress-bar bg-success';

                document.getElementById('val_vbat').textContent = d.voltaje_bateria || '--';
                document.getElementById('val_ibat').textContent = d.corriente_bateria || '--';

                const temp = d.temperatura || 0;
                document.getElementById('val_temp').textContent = temp;
                const tempPct = Math.min((temp / 60) * 100, 100);
                const tempFill = document.getElementById('temp_bar_fill');
                tempFill.style.width = `${tempPct}%`;
                tempFill.style.backgroundColor = getTempColor(temp);

                // --- AMBIENTE ---
                const envSection = document.getElementById('envSection');
                if (d.env_temperature || d.env_humidity) {
                    envSection.style.display = 'block';
                    document.getElementById('val_env_temp').textContent = d.env_temperature || '--';
                    document.getElementById('val_env_hum').textContent = d.env_humidity || '--';
                    const wl = d.water_leak || 0;
                    document.getElementById('val_water_leak').textContent = wl > 0 ? `ZONA ${wl}` : 'Sin fuga';
                    document.getElementById('val_water_leak').style.color = wl > 0 ? '#e74c3c' : '#2ecc71';
                }

                // --- MODULOS ---
                if (d.modules) {
                    renderModules(d.modules);
                }

                // --- ALARMAS ---
                renderAlarms(data.alarms || []);

                // --- UPDATE CHARTS ---
                const now = new Date().toLocaleTimeString();

                if (chartVIn) {
                    pushChartData(chartVIn, now, [d.voltaje_in_l1, d.voltaje_in_l2, d.voltaje_in_l3]);
                }
                if (chartVOut) {
                    pushChartData(chartVOut, now, [d.voltaje_out_l1, d.voltaje_out_l2, d.voltaje_out_l3]);
                }
                if (chartB) {
                    chartB.data.datasets[0].data = [bPct, 100 - bPct];
                    if (bPct < 20) chartB.data.datasets[0].backgroundColor[0] = '#e74c3c';
                    else if (bPct < 50) chartB.data.datasets[0].backgroundColor[0] = '#f39c12';
                    else chartB.data.datasets[0].backgroundColor[0] = '#2ecc71';
                    chartB.update();
                    document.getElementById('bat_center_label').textContent = `${bPct}%`;
                }
                if (chartFreq) {
                    pushChartData(chartFreq, now, [d.frecuencia_in, d.frecuencia_out]);
                }
                if (chartTemp) {
                    pushChartData(chartTemp, now, [temp, d.env_temperature || 0]);
                }
            }
        });

        // Init
        initCharts();
    </script>
</body>

</html>
